<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bagging and Random Forest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="1-6_files/libs/clipboard/clipboard.min.js"></script>
<script src="1-6_files/libs/quarto-html/quarto.js"></script>
<script src="1-6_files/libs/quarto-html/popper.min.js"></script>
<script src="1-6_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="1-6_files/libs/quarto-html/anchor.min.js"></script>
<link href="1-6_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="1-6_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="1-6_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="1-6_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="1-6_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bagging and Random Forest</h1>
<p class="subtitle lead">Lesson 1.6, Applied Machine Learning</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
<section id="contents" class="level2">
<h2 class="anchored" data-anchor-id="contents">Table of Contents</h2>
<ol type="1">
<li><a href="#bootstrap">Bootstrap Sampling</a></li>
<li><a href="#bagging">Bagging and Random Forest</a></li>
<li><a href="#r">Bagging and Random Forest in R</a></li>
<li><a href="#importance">Importance Statistics</a></li>
<li><a href="#importancer">Importance Statistics in R</a></li>
</ol>
<hr>
<p>Remember to load tidyverse. We will also need the package <strong>randomForest</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also load the dataset we will be using for these examples (feel free to load your own dataset)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"voctaxdata.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
<section id="bootstrap" class="level1">
<h1>Bootstrap Sampling</h1>
<p>Bagging and Random Forest are tree-based methods that build on the simple <a href="https://politicalscience.github.io/ml/1-5.html">tree regression</a>. While regression trees are a cool way to visualise predictions, they tend to have high variance: just slightly changing the data will result in a completely different tree being generated.</p>
<ul>
<li>This is an issue, especially if we are interested in predicting out-of-sample observations.</li>
</ul>
<p><br></p>
<p>Bagging (Bootstrap Aggergation) is a procedure for reducing the variance of a statistical learning method.</p>
<ul>
<li><p>In a set of <span class="math inline">\(n\)</span> samples <span class="math inline">\(Z_1, Z_2, ... , Z_n\)</span>, each with variance <span class="math inline">\(\sigma^2\)</span>, the variance of the mean <span class="math inline">\(\bar{Z}\)</span>’s of the observations is <span class="math inline">\(\sigma^2/n\)</span></p></li>
<li><p>What this means, essentially, is that averaging a set of predictions will reduce the variance in the predictions.</p></li>
</ul>
<p>However, there is one issue: we only have one prediction (from our training data). How do average a set of predictions if we only have one data set in which to predict from?</p>
<p><br></p>
<p>The answer is Bootstrap Sampling:</p>
<ul>
<li><p>Bootstrap Sampling is basically <strong>sampling with replacement</strong> from the data we already have.</p></li>
<li><p>To create a bootstrap sample, we choose 1 observation at random from our original sample. We add that observation to our bootstrap sample, and replace it back in the original sample. We then draw another observation, add it to our bootstrap sample, and replace it back. We do this <span class="math inline">\(n\)</span> times ( <span class="math inline">\(n\)</span> being the size of the bootstrap sample)</p></li>
<li><p>If we do this several times creating different Bootstrap Samples, we will have a few similar, but slightly different data sets. We are essentially replicating the process of obtaining new data sets, without actually gathering more data.</p></li>
<li><p>Now, with our multiple data sets, we can find the average, and reduce variance.</p></li>
</ul>
<p><br></p>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
<section id="bagging" class="level1">
<h1>Bagging and Random Forest</h1>
<p>Bagging (Bootstrap Aggregation) applies Bootstrap Sampling to Tree Regressions.</p>
<ul>
<li><p>We first generate <span class="math inline">\(B\)</span> different samples using Bootstrap Sampling.</p></li>
<li><p>We then train a tree on each different sample, creating a prediction function <span class="math inline">\(f_b(x)\)</span> for each sample, where <span class="math inline">\(b\)</span> represents the <span class="math inline">\(b\)</span>th sample.</p></li>
<li><p>Then, we average all the predictions to obtain our prediction function:</p></li>
</ul>
<p><span class="math display">\[
f_{bag}(x)=\frac{1}{B} \sum\limits_{b=1}^{B} f_b(x)
\]</span></p>
<p><br></p>
<p>Bagging reduces variance, and is one of the most accurate prediction methods, often outperforming linear and non-linear methods.</p>
<p>However, Bagging accuracy can still be improved. Bagging has an issue that the trees that are created are heavily correlated.</p>
<ul>
<li><p>Heavily correlated in this sense means that in general, the trees will have the same top-level <span class="math inline">\(x\)</span> variable.</p></li>
<li><p>This is a problem if we have on very strong predictor <span class="math inline">\(x\)</span> compared to others. This means that our trees will almost always have that <span class="math inline">\(x\)</span> at the top of the tree, making the trees similar despite our different samples.</p></li>
<li><p>Averaging highly correlated trees does not reduce variance very much.</p></li>
</ul>
<p>Reducing the correlation in predictions decreases variance, which is good for test set error.</p>
<p><br></p>
<p>Random Forest address this issue by not only Bootstrap Sampling observations like Bagging does, but also sampling predictor <span class="math inline">\(x\)</span> variables.</p>
<ul>
<li><p>For example, lets say you have 16 independent variables in your tree.</p></li>
<li><p>Bagging would include all 16 independent variables in every true.</p></li>
<li><p>Random Forest would instead sample 4 out of the 16 independent variables to use for every tree</p>
<ul>
<li>Typically, Random Forest samples the square root of the number of independent variables - this has been shown through testing to be the optimal amount on average.</li>
</ul></li>
<li><p>This means that Random Forest will exclude strong predictors in many trees, giving the other important predictors more of a chance.</p></li>
</ul>
<p>Thus, Random Forest will have less correlated trees, which further reduces variance when we take the average.</p>
<p><br></p>
<p>Random Forest is typically more accurate when it comes to out of set prediction than Bagging. However, this is not always the case, so it is important to check the explanatory power of both before altering.</p>
<p>One disadvantage is that we cannot have the easy interpretation of simple Tree Regressions. This is because it is impractical to view 500 different trees from different samples.</p>
<ul>
<li>One way to remedy this is with <a href="#importance">importance statistics</a>, which can illustrate the most important variables in a Bagging/Random Forest model.</li>
</ul>
<p><br></p>
<p>Uses of Bagging and Random Forest in Political Science research:</p>
<ul>
<li><p>Bagging and Random Forest are generally significantly more accurate in predictions than their linear/non-linear counterparts. This is especially the case when the relationships are not linear.</p></li>
<li><p>For example, Bagging and Random Forest have much better success in predictions of Civil War than linear/non-linear models do.</p></li>
</ul>
<p><br></p>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
<section id="r" class="level1">
<h1>Bagging and Random Forest in R</h1>
<p>To conduct Bagging and Random Forest, we need the package <strong>randomForest</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remember to load tidyverse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also load the dataset we will be using for these examples (feel free to load your own dataset)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"voctaxdata.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<section id="bagging-model-in-r" class="level4">
<h4 class="anchored" data-anchor-id="bagging-model-in-r">Bagging Model in R</h4>
<p>Bagging in R is conducted using the <strong>randomForest()</strong> function. We can view the summary by simply printing the regression variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember to install and load package randomForest</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed to keep the same results when we re-run</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>bagging <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Y <span class="sc">~</span> .,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> df,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.action =</span> na.omit,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">mtry =</span> <span class="dv">9</span>, <span class="co"># set to number of IV</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># call model variable to see output</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>bagging</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the parts of the syntax that can be altered:</p>
<ul>
<li><p><strong>bagging</strong> is the variable I am saving my regression model to. <em>You can name this anything you want to.</em></p></li>
<li><p><strong>Y</strong> is the Y variable (Dependent variable) you are trying to predict. <em>Replace this with the variables you want to use.</em></p></li>
<li><p>“<strong>.</strong>” after the tilda <strong>~</strong> tells R to include all other variables in the data frame as independent variables. This is very common for Bagging since you will typically include all variables.</p>
<ul>
<li>Note: Make sure to de-select variables you don’t want to include in the model, such as ID, date, etc.</li>
</ul></li>
<li><p><strong>df</strong> is the name of the data frame that I am drawing these X and Y variables from. <em>Replace this with the name of your data frame.</em></p></li>
<li><p>NOTE: Remember to include the sections <strong>na.action = na.omit</strong>, and <strong>importance = TRUE</strong>.</p></li>
</ul>
<p><br></p>
</section>
<section id="random-forest-in-r" class="level4">
<h4 class="anchored" data-anchor-id="random-forest-in-r">Random Forest in R</h4>
<p>To create a Random Forest model, the syntax is the exact same, except for the fact we set <strong>mtry</strong> to the square root of the number of independent variables in your regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember to install and load package randomForest</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed to keep the same results when we re-run</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>randomforest <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Y <span class="sc">~</span> .,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> df,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.action =</span> na.omit,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">mtry =</span> <span class="dv">3</span>, <span class="co"># square root of number of IV</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># call model variable to see output</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>randomforest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
<section id="predictions-in-r" class="level4">
<h4 class="anchored" data-anchor-id="predictions-in-r">Predictions in R</h4>
<p>We can generate predictions with the <strong>predict()</strong> function (just like we did in the Regression Tree section)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create new df for comparison of actual and prediction</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df_results <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Y) <span class="co">#optional, may help with readability</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># newdata is what values of X1, X2... to predict for.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>df_results<span class="sc">$</span>prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(bagging, <span class="at">newdata =</span> df)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># brief glimpse of the results</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the parts of the syntax that can be altered:</p>
<ul>
<li><p><strong>df_results</strong> is the results data frame I am creating. <em>You can name this anything you want to.</em></p></li>
<li><p><strong>Y</strong> is the Y variable I am trying to predict. <em>Replace this with the name of your Y variable.</em></p></li>
<li><p><strong>bagging</strong> is the variable I am saved my prior model to. <em>Rename this to what your prior model was named.</em></p></li>
<li><p><strong>df</strong> is the name of the data frame that houses the <span class="math inline">\(x\)</span> values I want to predict for. <em>Replace this with the name of your data frame with the</em> <span class="math inline">\(x\)</span> <em>values you want to predict for.</em></p></li>
</ul>
<p><br></p>
</section>
<section id="example-in-r" class="level4">
<h4 class="anchored" data-anchor-id="example-in-r">Example in R</h4>
<p>Take the following example of predicting <strong>econglobal</strong> using the rest of my independent variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set a seed to keep the same results when we re-run</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>rf_example <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(econglobal <span class="sc">~</span> .,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> df,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">na.action =</span> na.omit,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">mtry =</span> <span class="dv">3</span>, <span class="co">#approx sq rt of 7</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># call model variable to see output</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>rf_example</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
 randomForest(formula = econglobal ~ ., data = df, mtry = 3, importance = TRUE,      na.action = na.omit) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 3

          Mean of squared residuals: 3.851229
                    % Var explained: 93.68</code></pre>
</div>
</div>
<p>The output shows us some info about the tree we ran. The most useful parts of the above output are:</p>
<ul>
<li><p><strong>Mean of Squared Residuals</strong>: a general measure of how well the model performed.</p></li>
<li><p><strong>% Variance explained</strong>: how well our independent variables explain the variation in the Y variable. Similar to R^2 from linear regression.</p></li>
</ul>
<p>However, we can get more detailed information on this model. See the <a href="#importance">importance statistics</a> section for more information.</p>
<p><br></p>
<p>Now, let me run the predictions for in-sample data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create new df for comparison of actual and prediction</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df_results <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(econglobal)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># newdata is what values of X1, X2... to predict for.</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>df_results<span class="sc">$</span>prediction <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_example, <span class="at">newdata =</span> df)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># brief glimpse of the results</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  econglobal prediction
       &lt;dbl&gt;      &lt;dbl&gt;
1       66.9       67.2
2       66.9       67.5
3       68.4       68.5
4       69.6       68.5
5       66.6       66.9
6       67.4       67.0</code></pre>
</div>
</div>
<p><br></p>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
</section>
<section id="importance" class="level1">
<h1>Importance Statistics</h1>
<p>One downside we mentioned about <a href="#bagging">Bagging and Random Forest</a> is that it is not as easily interpretable as simple <a href="#trees">Regression Trees</a>.</p>
<ul>
<li><p>Regression Trees produce a nice diagram, with the most important variable at the top.</p></li>
<li><p>However, because Bagging and Random Forest average hundreds or thousands of different trees together, we can’t really diagram every one individually.</p></li>
</ul>
<p>However, importance statistics can help us interpret Bagging and Random Forest models.</p>
<p><br></p>
<p>We can calculate the importance of a variable through the reduction in the sum of squared errors whenever a variable is chosen to split.</p>
<ul>
<li><p>Remember, when we calculate a simple <a href="#trees">Tree Regression</a>, we note which variable reduces the residual sum of squares the most.</p></li>
<li><p>To calculate importance, we simply “remember” the reduction of the residual sum of squares for each variable when split, in each regression.</p></li>
<li><p>This is why in our earlier code for Bagging and Random Forest, we specified a condition <strong>importance = TRUE</strong>. We are telling the machine to “remember” the reduction in residual sum of squares.</p></li>
</ul>
<p><br></p>
<p>We can then graph the reduction in sum of squared errors when a variable is chosen to split:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1-6_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can clearly see that <strong>export</strong> is the most important X variable in predicting our Y variable, <strong>econglobal</strong>.</p>
<p><br></p>
<p>Uses of Importance Statistics in Political Science research:</p>
<ul>
<li><p>Often when we are making predictions (as we often do with Bagging and Random Forest), we want to know what is driving these predictions. This can help us plan and act, and potentially prevent the prediction from coming true.</p></li>
<li><p>For example, if we know what variables are frequently important in predicting civil wars, this may inform our approach in attempting to prevent civil wars.</p></li>
</ul>
<p><br></p>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
<section id="importancer" class="level1">
<h1>Importance Statistics in R</h1>
<p>To conduct Importance Statistics, we need the package <strong>randomForest</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remember to load tidyverse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also load the dataset we will be using for these examples (feel free to load your own dataset)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"voctaxdata.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<section id="importance-plot-in-r" class="level4">
<h4 class="anchored" data-anchor-id="importance-plot-in-r">Importance Plot in R</h4>
<p>To see the importance of each predictor variable, we can use the <strong>varImpPlot()</strong> function. YOU MUST HAVE ALREADY RUN A BAGGING/RANDOM FOREST MODEL TO DO THIS. The syntax is as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You need the package randomForest loaded</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(model_variable,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Title of the Graph"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the parts of the syntax that can be altered:</p>
<ul>
<li><p><strong>model_variable</strong> is the model I am running my importance plot on. <em>Rename this to the variable you saved your model to.</em></p></li>
<li><p><strong>“Title of the Graph”</strong> is the title you put on the graph. <em>You can change this to anything you want, just remember quotations.</em></p></li>
<li><p>NOTE: don’t change <strong>type = 2</strong>.</p></li>
</ul>
<p><br></p>
</section>
<section id="example-in-r-1" class="level4">
<h4 class="anchored" data-anchor-id="example-in-r-1">Example in R</h4>
<p>Take this following example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf_example,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Importance of Variables in Predicting Econglobal"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="1-6_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The higher the mean decrease in node purity, the more influential the predictor is in predicting the outcome variable.</p>
<ul>
<li>In our example, <strong>export</strong> is the most important predictor of our Y variable, <strong>econglobal</strong>.</li>
</ul>
<p><br></p>
<hr>
<p><a href="#contents">Table of Contents</a> | <a href="https://politicalscience.github.io/ml">Course Homepage</a></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>