<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Selection on Observables – Political Science &amp; Political Economy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="mathjax-config.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./causal.html">Causal Inference</a></li><li class="breadcrumb-item"><a href="./soo.html">5 Selection on Observables</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Kevin’s PSPE Resources</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
 <span class="menu-text">Quantitative Methods</span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 The Classical Linear Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glm.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 The Generalised Linear Model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Causal Inference</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 Causal Frameworks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 Randomised Controlled Trials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./soo.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">5 Selection on Observables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./iv.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rd.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 Regression Discontinuity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./did.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 Differences-in-Differences</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Prediction and Measurement</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predict.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9 Forecasting and Prediction Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./unsupervised.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 Unsupervised Learning Methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 Factor Analysis Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./latent.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 Latent Trait and Class Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sem.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13 Structural Equation Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./games.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide to Game Theory</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./math.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Background Mathematics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Background Statistics</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On This Page</h2>
   
  <ul>
  <li><a href="#identification" id="toc-identification" class="nav-link active" data-scroll-target="#identification"><strong>Identification</strong></a>
  <ul class="collapse">
  <li><a href="#blocking-backdoor-paths" id="toc-blocking-backdoor-paths" class="nav-link" data-scroll-target="#blocking-backdoor-paths">Blocking Backdoor Paths</a></li>
  <li><a href="#identification-assumptions" id="toc-identification-assumptions" class="nav-link" data-scroll-target="#identification-assumptions">Identification Assumptions</a></li>
  <li><a href="#identification-of-the-ate" id="toc-identification-of-the-ate" class="nav-link" data-scroll-target="#identification-of-the-ate">Identification of the ATE</a></li>
  <li><a href="#identification-of-the-att" id="toc-identification-of-the-att" class="nav-link" data-scroll-target="#identification-of-the-att">Identification of the ATT</a></li>
  </ul></li>
  <li><a href="#parametric-estimators" id="toc-parametric-estimators" class="nav-link" data-scroll-target="#parametric-estimators"><strong>Parametric Estimators</strong></a>
  <ul class="collapse">
  <li><a href="#ordinary-least-squares-estimator" id="toc-ordinary-least-squares-estimator" class="nav-link" data-scroll-target="#ordinary-least-squares-estimator">Ordinary Least Squares Estimator</a></li>
  <li><a href="#ols-bias-under-heterogeneity" id="toc-ols-bias-under-heterogeneity" class="nav-link" data-scroll-target="#ols-bias-under-heterogeneity">OLS Bias under Heterogeneity</a></li>
  <li><a href="#fully-interacted-estimator" id="toc-fully-interacted-estimator" class="nav-link" data-scroll-target="#fully-interacted-estimator">Fully Interacted Estimator</a></li>
  </ul></li>
  <li><a href="#nonparametric-estimators" id="toc-nonparametric-estimators" class="nav-link" data-scroll-target="#nonparametric-estimators"><strong>Nonparametric Estimators</strong></a>
  <ul class="collapse">
  <li><a href="#subclassification-estimator" id="toc-subclassification-estimator" class="nav-link" data-scroll-target="#subclassification-estimator">Subclassification Estimator</a></li>
  <li><a href="#matching-estimator" id="toc-matching-estimator" class="nav-link" data-scroll-target="#matching-estimator">Matching Estimator</a></li>
  <li><a href="#matching-with-multiple-covariates" id="toc-matching-with-multiple-covariates" class="nav-link" data-scroll-target="#matching-with-multiple-covariates">Matching with Multiple Covariates</a></li>
  <li><a href="#propensity-scores-matching" id="toc-propensity-scores-matching" class="nav-link" data-scroll-target="#propensity-scores-matching">Propensity Scores Matching</a></li>
  <li><a href="#genetic-matching" id="toc-genetic-matching" class="nav-link" data-scroll-target="#genetic-matching">Genetic Matching</a></li>
  </ul></li>
  <li><a href="#weighting-estimator" id="toc-weighting-estimator" class="nav-link" data-scroll-target="#weighting-estimator"><strong>Weighting Estimator</strong></a>
  <ul class="collapse">
  <li><a href="#identification-with-weighting" id="toc-identification-with-weighting" class="nav-link" data-scroll-target="#identification-with-weighting">Identification with Weighting</a></li>
  <li><a href="#inverse-probability-weighting-estimator" id="toc-inverse-probability-weighting-estimator" class="nav-link" data-scroll-target="#inverse-probability-weighting-estimator">Inverse Probability Weighting Estimator</a></li>
  </ul></li>
  <li><a href="#falsification-tests" id="toc-falsification-tests" class="nav-link" data-scroll-target="#falsification-tests"><strong>Falsification Tests</strong></a>
  <ul class="collapse">
  <li><a href="#testing-assumptions-with-falsification" id="toc-testing-assumptions-with-falsification" class="nav-link" data-scroll-target="#testing-assumptions-with-falsification">Testing Assumptions with Falsification</a></li>
  <li><a href="#placebo-outcome-test" id="toc-placebo-outcome-test" class="nav-link" data-scroll-target="#placebo-outcome-test">Placebo Outcome Test</a></li>
  <li><a href="#placebo-treatment-test" id="toc-placebo-treatment-test" class="nav-link" data-scroll-target="#placebo-treatment-test">Placebo Treatment Test</a></li>
  </ul></li>
  <li><a href="#extension-partial-identification" id="toc-extension-partial-identification" class="nav-link" data-scroll-target="#extension-partial-identification"><strong>Extension: Partial Identification</strong></a>
  <ul class="collapse">
  <li><a href="#decomposing-the-ate" id="toc-decomposing-the-ate" class="nav-link" data-scroll-target="#decomposing-the-ate">Decomposing the ATE</a></li>
  <li><a href="#nonparametric-bounds" id="toc-nonparametric-bounds" class="nav-link" data-scroll-target="#nonparametric-bounds">Nonparametric Bounds</a></li>
  <li><a href="#monotone-treatment-selection-assumption" id="toc-monotone-treatment-selection-assumption" class="nav-link" data-scroll-target="#monotone-treatment-selection-assumption">Monotone Treatment Selection Assumption</a></li>
  </ul></li>
  <li><a href="#implementation-in-r" id="toc-implementation-in-r" class="nav-link" data-scroll-target="#implementation-in-r"><strong>Implementation in R</strong></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./causal.html">Causal Inference</a></li><li class="breadcrumb-item"><a href="./soo.html">5 Selection on Observables</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Selection on Observables</h1>
<p class="subtitle lead">Chapter 5, Quantitative Methods (Causal Inference)</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In the last chapter, we discussed randomisation. Randomisation is great, but, it requires specific circumstances of the research having control over the assignment mechanism. However, in the social sciences, this rarely occurs.</p>
<p>This chapter introduces the selection on observables framework, which allows us to identify causal effects in an observational setting by controlling for observable pre-treatment covariates. We discuss the main estimators, including regression, matching, and weighting.</p>
<p>Use the right sidebar for quick navigation. R-code provided at the bottom.</p>
<hr>
<section id="identification" class="level1">
<h1><strong>Identification</strong></h1>
<section id="blocking-backdoor-paths" class="level3">
<h3 class="anchored" data-anchor-id="blocking-backdoor-paths">Blocking Backdoor Paths</h3>
<p>Without randomisation, we need some other way to account for pre-treatment covariates that may be confounding and causing selection bias. Controlling for a set of nodes/confounders <span class="math inline">\(X\)</span> can identify the causal effect of <span class="math inline">\(D \rightarrow Y\)</span>, if the following conditions are met:</p>
<ol type="1">
<li>No node within set <span class="math inline">\(X\)</span> is a descendant of <span class="math inline">\(D\)</span> (no element within <span class="math inline">\(X\)</span> results from <span class="math inline">\(D\)</span>).</li>
<li>The nodes within set <span class="math inline">\(X\)</span> <a href="./causal.html#blocked-paths">block all back-door paths</a> from <span class="math inline">\(D \rightarrow Y\)</span>.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-378311705.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%"></p>
</figure>
</div>
<p>In the figure above, let us block the backdoor paths between <span class="math inline">\(D \rightarrow Y\)</span>:</p>
<ol type="1">
<li>Backdoor path <span class="math inline">\(D \rightarrow X \rightarrow Y\)</span>. To block this path, we must control for <span class="math inline">\(X\)</span>.</li>
<li>Backdoor path <span class="math inline">\(D \rightarrow V \rightarrow Y\)</span>. We do not need to control for <span class="math inline">\(V\)</span>, since it is post-treatment (a descendant of <span class="math inline">\(D\)</span>). In fact, <span class="math inline">\(V\)</span> is a <strong>bad control</strong> (see below).</li>
</ol>
<p>Thus, to identify <span class="math inline">\(D \rightarrow Y\)</span> here, we only need to control for <span class="math inline">\(X\)</span>, and no other variable.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Good and Bad Controls
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Good controls block backdoor paths, which facilitate identification of the causal effect.</p>
<p>Bad controls are when we control for post-treatment variables. For example, <span class="math inline">\(P\)</span> below is a bad control, since it is caused by <span class="math inline">\(D\)</span>, so it is post-treatment.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1369053188.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%"></p>
</figure>
</div>
<p>You also never want to control variables that only predict <span class="math inline">\(D\)</span>. These are bad because controlling for these removes variation in <span class="math inline">\(D\)</span> that could be useful.</p>
<p>Neutral controls are ones that don’t identify the causal effect, but improve efficiency. For example, <span class="math inline">\(Q\)</span> below affects <span class="math inline">\(Y\)</span>, but there is no backdoor path. Controlling <span class="math inline">\(Q\)</span> will not help identification, but can control noise in <span class="math inline">\(Y\)</span> which may increase efficiency.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1555756596.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="identification-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="identification-assumptions">Identification Assumptions</h3>
<p>Once we have determined the set of confounders <span class="math inline">\(X\)</span> that we need to control to block all backdoor paths, the assumptions needed for identification of causal effects are:</p>
<ol type="1">
<li><strong>Conditional Ignorability</strong> (also known as exogeneity or independence): Among units with identical confounder values <span class="math inline">\(X_i\)</span>, treatment <span class="math inline">\(D_i\)</span> is as-if randomly assigned. Or in other words, potential outcomes are independent from treatment within each specific confounder value <span class="math inline">\(X_i = x\)</span>.</li>
</ol>
<p><span class="math display">\[
(Y_{0i}, Y_{1i}) \perp\!\!\!\!\perp D_i  \ | \ X_i = x, \quad \forall \ x \in \mathcal X
\]</span></p>
<p>This implies that for any given value of all confounders <span class="math inline">\(X_i = x\)</span>, we know that potential outcomes <span class="math inline">\(Y_{di}\)</span> are equivalent between treatment and control:</p>
<p><span id="eq-independence"><span class="math display">\[
\begin{split}
\E(Y_{1i}|X_i = x) = \E(Y_{1i}|D_i = 1, X_i = x) = \E(Y_{1i}|D_i = 0, X_i = x) \\
\E(Y_{0i}|X_i = x) = \E(Y_{0i}|D_i = 1, X_i = x) = \E(Y_{0i}|D_i = 0, X_i = x)
\end{split}
\tag{1}\]</span></span></p>
<ol start="2" type="1">
<li><strong>Common Support</strong>: for any unit <span class="math inline">\(i\)</span> with value of <span class="math inline">\(X_i\)</span>, there is a non-zero probability that they could be assigned to both control <span class="math inline">\(D_i = 0\)</span> or treatment <span class="math inline">\(D_i = 1\)</span>.</li>
</ol>
<p><span class="math display">\[
0 &lt; \P(D_i = 1 \ | X_i = x) &lt; 1 \quad \forall \ x \in \mathcal X
\]</span></p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example of Identification Assumptions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Imagine we have a theory that being abducted <span class="math inline">\(D\)</span> causes turning out to vote.</p>
<p>Blattman (2009) finds that age is the primary way violent groups chose to abduct individuals: abduction parties released young children and older adults, but kept all adolescent and young males.</p>
<p>That means our theory is that age <span class="math inline">\(X\)</span> affects selection into treatment <span class="math inline">\(D\)</span>. Young children and older adults are less likely to get abducted <span class="math inline">\(D\)</span>, while adolescent and young males are more likely <span class="math inline">\(D\)</span>.</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="identification-of-the-ate" class="level3">
<h3 class="anchored" data-anchor-id="identification-of-the-ate">Identification of the ATE</h3>
<p>With our assumptions above, we can identify the ATE. We start with the <a href="./causal.html#conditional-average-treatment-effect-cate">conditional average treatment effect</a>, conditional on some value of confounders <span class="math inline">\(X_i = x\)</span>. Note the properties shown in <a href="#eq-independence" class="quarto-xref">Equation&nbsp;1</a> .</p>
<p><span id="eq-cate"><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(Y_{1i} - Y_{0i} \ | \ X_i = x) \\
&amp; = \E(Y_{1i}|X_i = x) - \E(Y_{0i}|X_i = x) &amp;&amp; (\text{property of expectation}) \\
&amp; = \E(Y_{1i}|D_i = 1, X_i = x) - \E(Y_{0i}|D_i = 0X_i = x) &amp;&amp;( \because \text{equation (1)} \ ) \\
&amp; = \underbrace{\E(Y_i|D_i = 1, X_i = x)}_{\because \text{ observable}} - \underbrace{\E(Y_i|D_i = 0, X_i = x)}_{\because \text{ observable}}
\end{align}
\tag{2}\]</span></span></p>
<p>Now, let us discuss the ATE, and plug in the CATE from <a href="#eq-cate" class="quarto-xref">Equation&nbsp;2</a> to identify it:</p>
<p><span id="eq-ate"><span class="math display">\[
\begin{align}
\tau_{ATE} &amp; = \E(Y_{1i} - Y_{0i}) \\
&amp; = \int \underbrace{\E(Y_{1i} - Y_{0i} \ | \ X_i = x)}_{\tau_{CATE}(x)} d \ \underbrace{\P(X_i = x)}_{\text{weight}} &amp;&amp; (\text{weighted average})\\
&amp; = \int(\underbrace{\E(Y_i|D_i = 1, X_i) - \E(Y_i|D_i = 0, X_i)}_{\because \text{ equation (2)}})d \ \P(X_i = x)
\end{align}
\tag{3}\]</span></span></p>
<p>Thus <span class="math inline">\(\tau_{ATE}\)</span> is identified as the weighted average of all the CATEs, who themselves are difference-in-means of the observed <span class="math inline">\(Y_i\)</span> at every possible value of <span class="math inline">\(X_i = x\)</span>.</p>
<p>We assumed that the pre-treatment covariate <span class="math inline">\(X\)</span> is continuous. This is why we need an integral. However, we can simplify this if <span class="math inline">\(X\)</span> is discrete:</p>
<p><span id="eq-discreteate"><span class="math display">\[
\tau_{ATE} = \sum\limits_{x \in \mathcal X} ( \E(Y_i|D_i = 1, X_i = x) - \E(Y_i|D_i = 0, X_i = x)) \P(X_i = x)
\tag{4}\]</span></span></p>
<p><br></p>
</section>
<section id="identification-of-the-att" class="level3">
<h3 class="anchored" data-anchor-id="identification-of-the-att">Identification of the ATT</h3>
<p>We can weaken conditional ignorability, and still identify the ATT. Only <span class="math inline">\(Y_{0i}\)</span> needs to be independent of <span class="math inline">\(D_i\)</span> for units with the same covariates <span class="math inline">\(X_i\)</span>. Or in other words, <span class="math inline">\((Y_{0i}) \perp\!\!\!\perp D_i | X_i = x\)</span>. This implies:</p>
<p><span id="eq-weak"><span class="math display">\[
\E(Y_{0i}|X_i = x) = \E(Y_{0i}|D_i = 0, X_i = x) = \E(Y_{0i}|D_i = 1, X_i = x)
\tag{5}\]</span></span></p>
<p>Start with the conditional ATT, using weakened conditional ignorability from <a href="#eq-weak" class="quarto-xref">Equation&nbsp;5</a> :</p>
<p><span id="eq-catt"><span class="math display">\[
\begin{split}
\tau_{CATT}(x) &amp; = \E(Y_{1i}-Y_{0i}|D_i = 1, X_i = x) \\
&amp; = \E(Y_{1i}|D_i = 1, X_i = x) - \E(Y_{0i}|D_i = 1, X_i = x) \\
&amp; = \E(Y_{1i}|D_i = 1, X_i = x) - \underbrace{\E(Y_{0i}|D_i = 0, X_i = x)}_{\because \text{ equation (5)}} \\
&amp; = \underbrace{\E(Y_i|D_i=1, X_i = x)}_{\because \text{ observable}} - \underbrace{\E(Y_1|D_i = 0, X_i x)}_{\because \text{ observable}}
\end{split}
\tag{6}\]</span></span></p>
<p>Now, look at the ATT, and plug in CATT from <a href="#eq-catt" class="quarto-xref">Equation&nbsp;6</a> to identify it.</p>
<p><span class="math display">\[
\begin{align}
\tau_{ATT} &amp; = \E(Y_{1i} - Y_{0i}|D_i = 1) \\
&amp; = \int \underbrace{\E(Y_{1i} - Y_{0i}|D_i = 1, X_i = x)}_{\tau_{CATT}(x)}d \ \underbrace{\P(X_i = x|D_i = 1)}_{\P(X_i = x) \text{ within treated}} \\
&amp; = \int (\underbrace{\E(Y_i|D_i = 1, X_i = x) - \E(Y_i|D_i = 0, X_i = x)}_{\because \text{ equation (6)}})d \ \P(X_i = x|D_i = 1)
\end{align}
\]</span></p>
<p>We can simplify this if <span class="math inline">\(X\)</span> is discrete:</p>
<p><span class="math display">\[
\tau_{ATT} = \sum\limits_{x \in \mathcal X} ( \E(Y_i|D_i = 1, X_i = x) - \E(Y_i|D_i = 0, X_i = x)) \P(X_i = x | D_i = 1)
\]</span></p>
<p>Even when all assumptions are met for identification of the ATE, the <span class="math inline">\(\tau_{ATE}\)</span> can be different than the <span class="math inline">\(\tau_{ATT}\)</span>. This is because the weights <span class="math inline">\(\P(X_i = x|D_i = 1)\)</span> for the ATT are different than the ATE <span class="math inline">\(\P(X_i = x)\)</span>.</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="parametric-estimators" class="level1">
<h1><strong>Parametric Estimators</strong></h1>
<section id="ordinary-least-squares-estimator" class="level3">
<h3 class="anchored" data-anchor-id="ordinary-least-squares-estimator">Ordinary Least Squares Estimator</h3>
<p>OLS is a natural approach for controlling for confounders <span class="math inline">\(X\)</span>, since <span class="math inline">\(\hat\beta_{OLS}\)</span> estimates <a href="./clm.html##regression-anatomy-and-controlling">partial out the effects of covariates</a>. OLS is a good estimator of <span class="math inline">\(\tau_{ATE}\)</span> under 2 conditions:</p>
<ol type="1">
<li><strong>Constant treatment effect</strong>: <span class="math inline">\(\tau_i = Y_{1i} - Y_{0i}\)</span> for all units <span class="math inline">\(i\)</span>.</li>
<li><strong>Linearity</strong>: Potential outcomes are linear, and can be written as:</li>
</ol>
<p><span class="math display">\[
Y_i(d) = \beta_0 + d\beta_1 + \mathbf X_i \gamma + \varepsilon_i \quad \text{for} \quad d = 0, 1
\]</span></p>
<p>Why these conditions? Suppose we have the above linear potential outcomes. We can show:</p>
<p><span class="math display">\[
\begin{align}
\tau_i &amp; = Y_{1i} - Y_{0i} &amp;&amp; (\text{definition of } \tau_i) \\
&amp; = (\beta_0 + (1)\beta_1 + \mathbf X_i \gamma + \varepsilon_i) - (\beta_0 + (0)\beta_1 + \mathbf X_i \gamma + \varepsilon_i) &amp;&amp; (\text{plug in } Y_i(1), Y_i(0) \ )\\
&amp; = (\beta_0 + \beta_1 + \mathbf X_i \gamma + \varepsilon_i) - (\beta_0 + \mathbf X_i \gamma + \varepsilon_i) &amp;&amp; (\text{multiply}) \\
&amp; = \beta_0 + \beta_1 + \mathbf X_i \gamma + \varepsilon_i - \beta_0 - \mathbf X_i\gamma - \varepsilon_i &amp;&amp; (\text{distribute negative sign})\\
&amp; = \beta_1 &amp;&amp; (\text{cancel out terms})
\end{align}
\]</span></p>
<p>Thus, we see <span class="math inline">\(\tau_i = \beta_1\)</span>. We also know that conditional ignorability implies <a href="#0">zero-conditional mean</a>. Thus OLS is an unbiased and asymptotically consistent estimator of both <span class="math inline">\(\beta_1\)</span> and the ATE.</p>
<p>You should be cautious using OLS when assumption 2, <strong>linearity</strong>, is violated. We know the OLS is the <a href="./clm.html">best linear predictor of the conditional expectation function</a> in terms of mean squared error. Thus, <span class="math inline">\(\beta_1\)</span> will provide the best linear approximation to the population regression function.</p>
<p>This does not mean it is good - just the best linear approximation. How far your actual data is away from linearity will determine how good OLS is here.</p>
<p>You <strong>should not use</strong> OLS if you believe assumption 1, heterogeneity, is violated. The reasoning is explained below.</p>
<p><br></p>
</section>
<section id="ols-bias-under-heterogeneity" class="level3">
<h3 class="anchored" data-anchor-id="ols-bias-under-heterogeneity">OLS Bias under Heterogeneity</h3>
<p>What if there are <strong>heterogenous</strong> treatment effects (where <span class="math inline">\(\tau_i\)</span> is different between units)? Standard OLS in this case is <u><strong>no longer</strong> an unbiased estimator</u> of the ATE. Recall the discrete identification of the ATE (in equation <a href="#eq-discreteate" class="quarto-xref">Equation&nbsp;4</a> ) is a weighted average of CATEs:</p>
<p><span class="math display">\[
\hat\tau_{ATE} = \sum\limits_{x \in \mathcal X} ( \hat\tau_{CATE}(x)) \underbrace{\P(X_i = x)}_{\text{weight}} \\
\]</span></p>
<p>OLS, when there are non constant treatment effects, can also be rewritten as a weighted average of CATEs:</p>
<p><span class="math display">\[
\hat\beta_{OLS} = \sum\limits_{x \in \mathcal X} ( \hat\tau_{CATE}(x)) \underbrace{ \frac{\V(D_i|X_i = X)\P(X_i = x)}{\sum \V(D_i | X_i = x')\P(X_i = x')} }_{\text{weight}} \\
\]</span></p>
<p>Notice how the weights are different. The weights in the OLS are the conditional variances of <span class="math inline">\(D_i\)</span>. This means that OLS is <strong>not</strong> an unbiased estimator of the ATE or ATT, but rather, a weighted average of the ATT and ATU.</p>
<p>OLS, under heterogeneity, actually provides an unbiased estimator of the <strong>conditional variance weighted average treatment effect</strong>. This is not the same as the ATE or the ATT. This estimand can also be described as a weighted average of the ATT and the ATU:</p>
<p><span class="math display">\[
\tau_{OLS} = w_1 \cdot \tau_{ATT} + w_0 \cdot \tau_{ATU}
\]</span></p>
<p>Where:</p>
<p><span class="math display">\[
\begin{split}
w_1 &amp; = \frac{(1 - \P(D=1)) \V(\pi(X)|D = 0)}{\P(D=1)\V(\pi(X)|D=1) + (1-\P(D=1)\V(\pi(X)|D=0)} \\
w_0 &amp; = 1 - w_1
\end{split}
\]</span></p>
<p>The reason for this is because regression is prone to extrapolation beyond common support - i.e.&nbsp;it can “estimate” potential outcomes for units that are not observed. This can lead to bias. This is in contrast to the subclassification estimator, which cannot be computed if there are missing observable outcomes for a substratum/category of <span class="math inline">\(X\)</span>.</p>
<p>OLS also minimises estimation uncertainty by downweighting groups of <span class="math inline">\(X_i\)</span> where group-specific ATEs are less precisely estimated.</p>
<p><br></p>
</section>
<section id="fully-interacted-estimator" class="level3">
<h3 class="anchored" data-anchor-id="fully-interacted-estimator">Fully Interacted Estimator</h3>
<p>The <strong>Fully-Interacted Estimator</strong>, a newly developed large-sample regression estimator (Lin 2013), solves the heterogeneity bias in the OLS estimator. The fully-interacted estimator takes the form:</p>
<p><span class="math display">\[
Y_i = \hat\alpha + D_i \widehat{\tau}_{int} + (\mathbf X_i - \mathbf {\bar X}) \hat\beta +D_i (\mathbf X_i - \mathbf{\bar X}) \hat\gamma + \hat\varepsilon_i
\]</span></p>
<ul>
<li>Where <span class="math inline">\(X_i\)</span> are covariate values sufficient to satisfy conditional independence.</li>
<li>Where <span class="math inline">\(\bar X\)</span> contains the sample means of all <span class="math inline">\(X_i\)</span> covariates.</li>
</ul>
<p>This estimator <span class="math inline">\(\hat\tau_{int}\)</span> is technically biased when estimating <span class="math inline">\(\tau_{ATE}\)</span>. However, the bias is arbitrarily small in large samples under conditional ignorability.</p>
<p>This estimator thus allows us to accurately estimate the ATE even under heterogenous treatment effects, assuming our sample size is sufficiently large.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Other Solutions to the OLS Bias under Heterogeneity
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>There are a few other solutions to this issue of OLS bias under heterogeneity:</p>
<ol type="1">
<li><strong>Doubly-robust estimation</strong> uses a weighted average of regression and IPW estimators, which will be asymptotically consistent as long as the regression model is correctly specified.</li>
<li><strong>Matching as pre-processing</strong> uses matching to make treatment and control groups similar, then runs regression models to estimate causal effects.</li>
</ol>
</div>
</div>
</div>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="nonparametric-estimators" class="level1">
<h1><strong>Nonparametric Estimators</strong></h1>
<section id="subclassification-estimator" class="level3">
<h3 class="anchored" data-anchor-id="subclassification-estimator">Subclassification Estimator</h3>
<p>Using the discrete identification of the ATE shown in <a href="#eq-discreteate" class="quarto-xref">Equation&nbsp;4</a> , we can instead use the sample equivalents to get the <strong>subclassification estimator</strong>:</p>
<p><span class="math display">\[
\hat\tau_{ATE} = \sum\limits_{j=1}^M \underbrace{(\bar Y_{1j} - \bar Y_{0j})}_{\tau_{CATE}(j)} \underbrace{\frac{n_j}{n}}_{\text{weight}}
\]</span></p>
<ul>
<li>Where <span class="math inline">\(M\)</span> is the number of levels/categories of <span class="math inline">\(X\)</span>, and <span class="math inline">\(j\)</span> is one specific level/category of <span class="math inline">\(X\)</span>.</li>
<li>Where <span class="math inline">\(n_j\)</span> is the number of units in a level/category <span class="math inline">\(j\)</span> of <span class="math inline">\(X\)</span>.</li>
<li>Where <span class="math inline">\(\bar Y_{dj}\)</span> is the mean outcome for units with <span class="math inline">\(D_i = d\)</span> in level/category <span class="math inline">\(j\)</span> of <span class="math inline">\(X\)</span>.</li>
</ul>
<p>More intuitively, the procedure is as follows:</p>
<ol type="1">
<li>Choose one specific value for all covaraites <span class="math inline">\(X\)</span>. Find the ATE within this specific value of <span class="math inline">\(X\)</span>.</li>
<li>Multiply that average treatment effect by the number of observations that meet this specific value of <span class="math inline">\(X\)</span> divided by the total number of units.</li>
<li>Do this for every possible values of all covaraites <span class="math inline">\(X\)</span>, then sum up all the weighted average treatment effects to get the overall ATE.</li>
</ol>
<p>For subclassificaion to be possible, within each level <span class="math inline">\(j\)</span> of covariate <span class="math inline">\(X\)</span>, there must be at least one unit in control <span class="math inline">\(D=0\)</span> and treatment <span class="math inline">\(D=1\)</span>. Subclassification is not a particularly popular estimator, because it only works if all covariates are discrete, and only if you have a manageable amount of categories and covariates.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Subclassification with Multiple Confounders
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Let us say we have 2 confounders, <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span>. Both confounders are categorical with 3 categories.</p>
<p>We would need to create <span class="math inline">\(M=9\)</span> levels of strata, for every possible combination of values of <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span>. Then, we would estimate the within-strata average treatment effect, and weight them.</p>
<p>This illustrates how with large amounts of confounders, you will need a huge number of stratum. This makes subclassification infeasible in many cases.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Subclassification for the ATT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>When pre-treatment covariate <span class="math inline">\(X\)</span> is discrete, the identification result of the ATT is:</p>
<p><span class="math display">\[
\tau_{ATT} = \sum\limits_{x \in \mathcal X} ( E(Y_i|D_i = 1, X_i = x) - E(Y_i|D_i = 0, X_i = x)) P(X_i = x | D_i = 1)
\]</span></p>
<p>We can calculate this within our give sample to get the subclassificaiton estimator:</p>
<p><span class="math display">\[
\hat\tau_{ATT} = \sum\limits_{j=1}^M(\bar Y_{1j} - \bar Y_{0j}) \frac{n_{1j}}{n_1}
\]</span></p>
<ul>
<li>Where <span class="math inline">\(M\)</span> is the number of strata (levels/categories of <span class="math inline">\(X\)</span>).</li>
<li>Where <span class="math inline">\(n_j\)</span> is the number of units in a level/category <span class="math inline">\(j\)</span> of <span class="math inline">\(X\)</span>.</li>
<li>Where <span class="math inline">\(n_{1j}\)</span> is the number of treated cells <span class="math inline">\(D = 1\)</span> in a level/category <span class="math inline">\(j\)</span> of <span class="math inline">\(X\)</span>.</li>
<li>Where <span class="math inline">\(\bar Y_{dj}\)</span> is the mean outcome for units with <span class="math inline">\(D_i = d\)</span> in level/category <span class="math inline">\(j\)</span> of <span class="math inline">\(X\)</span>.</li>
</ul>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="matching-estimator" class="level3">
<h3 class="anchored" data-anchor-id="matching-estimator">Matching Estimator</h3>
<p>We have a <a href="./causal.html#observed-outcomes-and-missing-data">missing data problem</a> in causal inference: we do not know all the potential outcomes. Matching “estimates” missing potential outcomes of a unit.</p>
<p>For each observation in the treated group, matching finds an observation in the untreated group that have the most similar values of a set of pre-treatment covariates <span class="math inline">\(X\)</span>. Thus, we have pairs of treatment-control observations that act as counterfactuals. We can estimate the ATT as the average difference in observed outcomes within the pairs:</p>
<p><span class="math display">\[
\hat\tau_{ATT} = \frac{1}{n_1} \sum\limits_{i:D_i = 1}(Y_i - \widetilde{Y_i})
\]</span></p>
<ul>
<li>Where <span class="math inline">\(n_1\)</span> is the number of units in the treatment group.</li>
<li>Where <span class="math inline">\(Y_i\)</span> is the unit’s observed <span class="math inline">\(Y\)</span> in the treatment group.</li>
<li>Where <span class="math inline">\(\tilde Y_i\)</span> is unit <span class="math inline">\(i\)</span>’s closest neighbour in the untreated group.</li>
</ul>
<p>Sometimes, a treatment unit may not have one close control unit to match to. Instead, we could use a combination of control units to match to the treatment unit, and use the average <span class="math inline">\(Y\)</span> of those combination of control units to approximate a more accurate match.</p>
<p>Suppose we use <span class="math inline">\(M_i\)</span> number of close control units to match to a treatment unit <span class="math inline">\(i\)</span>. Then, the matching estimator would be defined as follows:</p>
<p><span class="math display">\[
\hat\tau_{ATT} = \frac{1}{n_1} \sum\limits_{i:D_i = 1}(Y_i - \left(\frac{1}{M_i} \sum\limits_{m=1}^{M_i} \widetilde{Y_{i_m}}\right))
\]</span></p>
<p>Where <span class="math inline">\(\widetilde{Y_{i_m}}\)</span> is the obsered outcome for the <span class="math inline">\(m\)</span>th match of unit <span class="math inline">\(i\)</span>.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Choices during Matching
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We have to make several choices when conducting matching.</p>
<ol type="1">
<li><strong>What covariates</strong> to match on. We generally want to select a set of pre-treatment covariates <span class="math inline">\(X\)</span> such that these covariates ensure the conditional ignorability assumption is met.</li>
<li>Match <strong>with or without replacement</strong>. Matching with replacement means that once you have used one control unit to match to a treatment unit, you can still use that same control unit to match to another treatment unit. This has advantages since you can ensure better and closer matches. However, matching without replacement is also possible.</li>
<li><strong>How many to match</strong>. You can decide to match multiple control units to one treatment unit, and use the average of the treatment units to approximate a true control unit. This may result in more accurate matches for treatment units that may not have a good single control unit to match to.</li>
</ol>
<p>We can also choose to use more advanced matching methods, such as Mahalanobis Distance matching or Propensity Score matching, which are shown below. These are good for matching on more <span class="math inline">\(X\)</span>.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Weaknesses of Matching
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Matching does not always create “perfect” matches. This means that the pairs matched together may not be identical to each other in terms of covariates <span class="math inline">\(X\)</span> or potential outcomes.</p>
<p>The inability to find exact matches can cause bias, especially for the more covariates we match on (see below).</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="matching-with-multiple-covariates" class="level3">
<h3 class="anchored" data-anchor-id="matching-with-multiple-covariates">Matching with Multiple Covariates</h3>
<p>Consider that we <span class="math inline">\(k&gt;1\)</span> number of confounders <span class="math inline">\(X\)</span>. Now, we have to match observations in <span class="math inline">\(k\)</span> variables, which implies we are in a multidimensional <span class="math inline">\(\mathbb R^k\)</span> space. The most commonly used distance metric is <strong>Mahalanobis</strong> Distance - which measures the distance in <span class="math inline">\(X_i\)</span> between units <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>:</p>
<p><span class="math display">\[
D_M (\mathbf X_i, \mathbf X_j) = \sqrt{(\mathbf X_i - \mathbf X_j)^T \boldsymbol\Sigma_X^{-1} (\mathbf X_i - \mathbf X_j)}, \quad \boldsymbol\Sigma_X \text{ is the variance-covariance matrix of X}
\]</span></p>
<p>However, when we try to match on more than one <span class="math inline">\(X\)</span> variable, we go from matching on a number line <span class="math inline">\(\mathbb R^1\)</span> to a <span class="math inline">\(n\)</span>-dimensional space, <span class="math inline">\(\mathbb R^n\)</span>. The search space increases exponentially as you increase the number of dimensions.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2668193698.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>If we match on a one dimensional plane (say the horizontal line between 0 and 1 on the left), we can see our red line covers approximately 30% between 0 and 1. But in 3 dimensions, our red box covers a significantly less proportion of the entire cube. On the right, <span class="math inline">\(d\)</span> represents the dimensions. We can see as <span class="math inline">\(d\)</span> increases, the fraction of volume increases significantly slower relative to distance. Thus, with a bigger space, the distance between two units increases, so you get worse matches.</p>
<p>This curse of dimensionality creates a <a href="./stats.html#finite-sample-properties-of-estimators">bias</a> problem - since we get non-exact matches. The more dimensions you add, the worse it becomes.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
More on Bias
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The poor matches caused by increased dimensionality inject error into our estimates of missing potential outcomes.</p>
<p>The bias term as you increase the number of dimensions <span class="math inline">\(k\)</span>, changes by <span class="math inline">\(N^{(-1/k)}\)</span>. This implies no <span class="math inline">\(\sqrt{n}\)</span> consistency for <span class="math inline">\(k&gt;2\)</span>.</p>
<p>If <span class="math inline">\(N_0\)</span> (number of untreated units) is much larger than <span class="math inline">\(N_1\)</span> (number of treated units), bias will typically be smaller.</p>
<p>There are ways to correct this bias, including Abadie and Imbens (2011) Bias Correction method.</p>
<p>There is a new method: <strong>Bias-corrected matching</strong>, which estimates bias ineherent to mathching estimators via regression, then subtracts it from the matching estimate to correct for it.</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="propensity-scores-matching" class="level3">
<h3 class="anchored" data-anchor-id="propensity-scores-matching">Propensity Scores Matching</h3>
<p>Propensity Score matching is an alternative way to match over many dimensions. The <strong>propensity score</strong> is an unobserved property, defined as the probability of a unit <span class="math inline">\(i\)</span> of receiving treatment:</p>
<p><span class="math display">\[
\pi(X_i) \equiv \P(D_i = 1|X_i)
\]</span></p>
<p>When supposing the <a href="#identification-assumptions">conditional ignorability and common support assumptions</a>, the propensity score <span class="math inline">\(\pi(X_i)\)</span> has the balancing property: <span class="math inline">\(D_i \perp X_i \ | \ \pi(X_i)\)</span>. This implies that conditional ignorability holds on the propensity scores alone:</p>
<p><span class="math display">\[
(Y_{1i}, Y_{0i}) \perp\!\!\!\!\perp D_i \ | \ \pi(X_i)
\]</span></p>
<p>Thus, instead of conditioning on <span class="math inline">\(X_i\)</span> as we did in selection on observables, we can instead condition on <span class="math inline">\(\pi (X_i)\)</span>, and still identify the causal estimand.</p>
<p>However, we do not actually observe <span class="math inline">\(\pi (X_i)\)</span>. We estimate <span class="math inline">\(\pi (X_i)\)</span> with a binary response model, with outcome variable <span class="math inline">\(D_i\)</span>, and explanatory variables <span class="math inline">\(X_i\)</span>. This will get us a fitted probability <span class="math inline">\(\P(D_i = 1) = \hat\pi(X_i)\)</span>.</p>
<p>Then, once we have the propensity score estimates <span class="math inline">\(\hat\pi(X_i)\)</span>, we can do nearest neighbour matching with the propensity scores (in <span class="math inline">\(\mathbb R^1\)</span>). This will allow us to identify the <span class="math inline">\(\tau_{ATT}\)</span>.</p>
<p>The accurate estimation of <span class="math inline">\(\tau_{ATT}\)</span> implies an accurate prediction of the propensity scores <span class="math inline">\(\pi(X_i)\)</span>. We can test our matched treatment and control groups to see if the balancing property holds for covariates <span class="math inline">\(X_i\)</span>.</p>
<p><br></p>
</section>
<section id="genetic-matching" class="level3">
<h3 class="anchored" data-anchor-id="genetic-matching">Genetic Matching</h3>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="weighting-estimator" class="level1">
<h1><strong>Weighting Estimator</strong></h1>
<section id="identification-with-weighting" class="level3">
<h3 class="anchored" data-anchor-id="identification-with-weighting">Identification with Weighting</h3>
<p>We know that the ATE can be written as a weighted average, as shown in <a href="#eq-discreteate" class="quarto-xref">Equation&nbsp;4</a> . We can rewrite the <span class="math inline">\(\tau_{ATE}\)</span> as follows using observed potential outcomes outcomes and conditional ignorability ( <a href="#eq-independence" class="quarto-xref">Equation&nbsp;1</a> ).</p>
<p><span class="math display">\[
\begin{split}
&amp; = \sum\limits_{x \in \mathcal X} \underbrace{(\E(Y_{1i}|D_i = 1, X_i = x)}_{\because \text{ observed}} - \underbrace{\E(Y_{0i}|D_i = 0, X_i = x)}_{\because \text{ observed}})\P(X_i = x) \\
&amp; = \sum\limits_{x \in \mathcal X}  (\underbrace{\E(Y_{1i}|X_i = x)}_{\because \text{ eq. (1)}} - \underbrace{\E(Y_{0i}|X_i = x)}_{\because \text{ eq. (1)}})\P(X_i = x) \\
&amp; = \underbrace{\E[\E(Y_{1i}|X_i = x) - \E(Y_{0i}|X_i = x)]}_{\text{definition of weighted average}}
\end{split}
\]</span></p>
<p>Let us do an algebra trick - multiply both terms within the CATE by 1 (in blue):</p>
<p><span class="math display">\[
\begin{split}
&amp; = \E \left [\E(Y_{1i}|X_i=x) \color{blue}{\frac{\pi(X_i)}{\pi(X_i)}}\color{black} - (\E(Y_{0i}|X_i=x) \color{blue}{\frac{1-\pi(X_i)}{1-\pi(X_i)}} \right] \\
&amp; \color{black} = \E \left[ \frac{\E(Y_{1i}|X_i = x) \pi(X_i)}{\pi(X_i)} -  \frac{\E(Y_{0i}|X_i = x) (1-\pi(X_i))}{1-\pi(X_i)} \right]
\end{split}
\]</span></p>
<p>We know that propensity score <span class="math inline">\(\pi(X_i) := \E(D_i|X_i = x)\)</span>. Thus, we can convert the above to:</p>
<p><span class="math display">\[
\begin{split}
&amp; = \E \left[ \frac{\E(Y_{1i}|X_i = x)\E(D_i|X_i = x)}{\pi(X_i)} - \frac{\E(Y_{0i}|X_i = x)(1-\E(D_i|X_i = x))}{1-\pi(X_i)}\right] \\
&amp; = \E \left[ \frac{\E(Y_{1i}|X_i = x)\E(D_i|X_i = x)}{\pi(X_i)} - \frac{\E(Y_{0i}|X_i = x)\E(1-D_i|X_i = x)}{1-\pi(X_i)}\right]
\end{split}
\]</span></p>
<p><span class="math display">\[
\begin{align}
&amp; = \E \left[ \frac{\E(Y_{1i}D_i|X_i = x)}{\pi(X_i)} - \frac{\E(Y_{0i}(1-D_i)|X_i = x)}{1 - \pi(X_i)}\right] &amp;&amp; (\text{property of expectation})\\
&amp; = \E \left[ \E \left( \frac{Y_{1i}D_i}{\pi(X_i)} |X_i = x\right) - \E \left( \frac{Y_{0i}(1-D_i)}{1-\pi(X_i)} | X_i = x \right) \right] &amp;&amp; (\text{property of expectation})\\
&amp; = \E\left[ \E\left( \frac{Y_{1i}D_i}{\pi(X_i)} - \frac{Y_{0i}(1-D_i)}{1-\pi(X_i)} |X_i = x \right) \right]  &amp;&amp; (\text{property of expectation})
\end{align}
\]</span></p>
<p><span id="eq-ateweight"><span class="math display">\[
\begin{align}
&amp; = \E\left( \frac{Y_{1i}D_i}{\pi(X_i)} - \frac{Y_{0i}(1-D_i)}{1-\pi(X_i)}\right) &amp;&amp; (\text{LIE: } \E(X) = E[E(X|Y)] \ ) \\
&amp; = \E\left( \frac{Y_{i}D_i}{\pi(X_i)} - \frac{Y_{i}(1-D_i)}{1-\pi(X_i)}\right) &amp;&amp; (\text{observered outcome}) \\
&amp; = \E \left( \frac{\color{blue}{Y_i} \color{black}D_i(1-\pi(X_i))-\color{blue}{Y_i}\color{black}(1-D_i)\pi(X_i)}{\pi(X_i)(1-\pi(X_i))}\right) &amp;&amp;(\text{getting common denom.}) \\
&amp; = \E\left( Y_i \frac{D_i(1-\pi(X_i))-(1-D_i)\pi(X_i)}{\pi(X_i)(1-\pi(X_i))}\right) &amp;&amp;(\text{factor out }Y_i) \\
&amp; = \E\left( Y_i \frac{D_i - D_i\pi(X_i)-(\pi(X_i) -D_i\pi(X_i))}{\pi(X_i)(1-\pi(X_i))}\right) &amp;&amp;(\text{distribute out}) \\
&amp;  = \E\left( Y_i \frac{D_i \color{blue}{- D_i\pi(X_i)} \color{black}-\pi(X_i) \color{blue}{+ D_i\pi(X_i)}}{\pi(X_i)(1-\pi(X_i))}\right) &amp;&amp;(\text{distribute out negative})\\
&amp; = \E\left( Y_i \frac{D_i -\pi(X_i) }{\pi(X_i)(1-\pi(X_i))}\right) &amp;&amp; (\text{cancel out})\\
\end{align}
\tag{7}\]</span></span></p>
<p>And thus, we have identified the ATE.</p>
<p><br></p>
</section>
<section id="inverse-probability-weighting-estimator" class="level3">
<h3 class="anchored" data-anchor-id="inverse-probability-weighting-estimator">Inverse Probability Weighting Estimator</h3>
<p>An alternative use of propensity scores is weighting. As shown above, under conditional ignorability and common support, we can identify the ATE as:</p>
<p><span class="math display">\[
\tau_{ATE} = \E\left[ Y_i \times \underbrace{\frac{D_i - \pi(X_i)}{\pi(X_i) (1 - \pi(X_i))}}_{\text{weight}}\right]
\]</span></p>
<p>The <strong>inverse probability weighting (IPW) estimator</strong> is the sample estimator:</p>
<p><span class="math display">\[
\begin{split}
\hat\tau_{ATE} &amp; = \frac{1}{N} \sum\limits_{i=1}^N \left(Y_i \frac{D_i - \hat\pi(X_i)}{\hat\pi(X_i) (1 - \hat\pi(X_i))} \right) \\
&amp; = \frac{1}{N} \sum\limits_{i=1}^N \left(\frac{D_i Y_i}{\hat\pi(X_i)} - \frac{(1-D_i) Y_i}{1 - \hat\pi(X_i)} \right)
\end{split}
\]</span></p>
<ul>
<li>The second equation is equivalent to the first, shown by <a href="#eq-ateweight" class="quarto-xref">Equation&nbsp;7</a> .</li>
</ul>
<p>Essentially, those who are unlikely to be treated but do get treated get weighted more, and individuals who are likely to be treated but do not get treated get weighted more.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Weighting Estimator for ATT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The identification of the ATT under both conditional ignorability and common support are:</p>
<p><span class="math display">\[
\tau_{ATT} = \frac{1}{\P(D = 1)} \times \E\left[ Y_i \times \underbrace{\frac{D_i - \pi(X_i)}{(1 - \pi(X_i))}}_{\text{weight}}\right]
\]</span></p>
<p>The sample IPW estimator would be:</p>
<p><span class="math display">\[
\begin{split}
\hat\tau_{ATT} &amp; = \frac{1}{N_1}\sum\limits_{i=1}^N \left( Y_i \frac{D_i - \hat\pi(X_i)}{1 - \hat\pi(X_i)} \right) \\
&amp; = \frac{1}{N_1} \sum\limits_{i=1}^N \left( D_iY_i - (1-D_i)Y_i \frac{\hat\pi(X_i)}{1 - \hat\pi(X_i)} \right)
\end{split}
\]</span></p>
</div>
</div>
</div>
<p>The IPW estimator is <a href="./stats.html#asymptotic-properties-of-estimators">asymptotically consistent</a>, but has very poor small sample properties. They are highly sensitive to extreme values of <span class="math inline">\(\hat\pi(X_i)\)</span>. This generates high variance (inefficiency), and can produce significant bias under model mispecification.</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="falsification-tests" class="level1">
<h1><strong>Falsification Tests</strong></h1>
<section id="testing-assumptions-with-falsification" class="level3">
<h3 class="anchored" data-anchor-id="testing-assumptions-with-falsification">Testing Assumptions with Falsification</h3>
<p>The stronger (bolder) our assumptions for identification, the less credible our results are. Selection on Observables involves a very strong and hard to verify assumption: <a href="#identification-assumptions">conditional ignorability</a>. Can we really be sure that we have controlled for all confounders <span class="math inline">\(X_i\)</span> needed to satisfy conditional ignorability?</p>
<p><strong>Placebo tests</strong> are a type of falsification test to show evidence against our assumptions. Suppose that we make the assumption of conditional ignorability <span class="math inline">\((Y_{0i}, Y_{1i}) \perp D_i | X_i\)</span>. Suppose we are concerned about the presence of another confounder <span class="math inline">\(U\)</span> that is not included in <span class="math inline">\(X_i\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1922523996.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p>The presence of <span class="math inline">\(U\)</span> will <strong>falsify</strong> our conditional ignorability assumption, and means we cannot identify the causal effect of <span class="math inline">\(D \rightarrow Y\)</span>.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Falsification vs.&nbsp;Validation
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Falsification is a principle of trying to criticise our own research, rather than defend it. Falsification is about testing if our assumptions are not met. Failing a test provides evidence that our assumption is not met.</p>
<ul>
<li>Ex. Covariates are balanced - thus there is <strong>no evidence</strong> that our assumptions are not met. We are not saying that our assumption is correct, just that there is no evidence against it.</li>
</ul>
<p>Validation is the opposite - we test to see if there is evidence in favour of our assumptions.</p>
<ul>
<li>Ex. Covariates are balanced - thus our assumptions are met.</li>
</ul>
</div>
</div>
</div>
<p>For falsification tests, we should not just pay attention to statistical significance - we must also pay attention to the magnitude of the point estimation.</p>
<p><br></p>
</section>
<section id="placebo-outcome-test" class="level3">
<h3 class="anchored" data-anchor-id="placebo-outcome-test">Placebo Outcome Test</h3>
<p>A <strong>placebo outcome test</strong> utilities another alternative outcome variable <span class="math inline">\(Y'\)</span> that is caused by our hypothesised unobserved confounder <span class="math inline">\(U\)</span>:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1507754175.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:45.0%"></p>
</figure>
</div>
<p>We can see that if <span class="math inline">\(U\)</span> does not exist, <span class="math inline">\(D\)</span> should have zero effect on the new outcome <span class="math inline">\(Y'\)</span>. Thus, if <span class="math inline">\(U\)</span> is present, we should find a relationship between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y'\)</span>.</p>
<p><span class="math display">\[
Y'_i = \gamma + \delta D_i + \varepsilon_i
\]</span></p>
<ul>
<li>If we find that there is an effect of <span class="math inline">\(D\)</span> on the new outcome <span class="math inline">\(Y'\)</span> (non-zero <span class="math inline">\(\delta\)</span>), that is <strong>evidence</strong> that <span class="math inline">\(U\)</span> exists, and is <strong>evidence to reject</strong> our conditional ignorability assumption (falsifies our design - red flag!).</li>
<li>If you do not find an effect of <span class="math inline">\(D\)</span> on new outcome <span class="math inline">\(Y'\)</span> (<span class="math inline">\(\delta = 0\)</span>) you find <strong>no evidence</strong> of <span class="math inline">\(U\)</span>, and <strong>no evidence to reject</strong> our conditional ignorability assumption (fails to falsify our design).</li>
</ul>
<p>We must be sure that <span class="math inline">\(Y\)</span> is not related to <span class="math inline">\(Y'\)</span> except through <span class="math inline">\(D\)</span> and <span class="math inline">\(U\)</span>. If this is true, we just run our original research design but replace <span class="math inline">\(Y\)</span> with <span class="math inline">\(Y'\)</span>.</p>
<p><br></p>
</section>
<section id="placebo-treatment-test" class="level3">
<h3 class="anchored" data-anchor-id="placebo-treatment-test">Placebo Treatment Test</h3>
<p>A <strong>placebo treatment test</strong> involves some other treatment <span class="math inline">\(D'\)</span>, that was assigned at the same time</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2903631229.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%"></p>
</figure>
</div>
<p>We can see that if <span class="math inline">\(U\)</span> does not exist, the effect of <span class="math inline">\(D'\)</span> should have no effect on <span class="math inline">\(Y\)</span>. If <span class="math inline">\(U\)</span> does exist, there should be some effect of <span class="math inline">\(D'\)</span> on <span class="math inline">\(Y\)</span>.</p>
<p><span class="math display">\[
Y_i = \gamma + \delta D'_i + \varepsilon_i
\]</span></p>
<ul>
<li>If we find that there is an effect of <span class="math inline">\(D'\)</span> on <span class="math inline">\(Y\)</span> (non-zero <span class="math inline">\(\delta\)</span>), that is <strong>evidence</strong> that <span class="math inline">\(U\)</span> exists, and is <strong>evidence to reject</strong> our conditional ignorability assumption (falsifies our design - red flag!).</li>
<li>If you do not find an effect of <span class="math inline">\(D'\)</span> on <span class="math inline">\(Y\)</span> (<span class="math inline">\(\delta = 0\)</span>) you find <strong>no evidence</strong> of <span class="math inline">\(U\)</span>, and <strong>no evidence to reject</strong> our conditional ignorability assumption (fails to falsify our design).</li>
</ul>
<p>We must be sure that <span class="math inline">\(Y\)</span> is not related to <span class="math inline">\(D'\)</span> except through <span class="math inline">\(D\)</span> and <span class="math inline">\(U\)</span>. If this is true, we just run our original research design but replace <span class="math inline">\(D\)</span> with <span class="math inline">\(D'\)</span>.</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="extension-partial-identification" class="level1">
<h1><strong>Extension: Partial Identification</strong></h1>
<section id="decomposing-the-ate" class="level3">
<h3 class="anchored" data-anchor-id="decomposing-the-ate">Decomposing the ATE</h3>
<p>With falsification, we were concerned with what assumptions we needed to be not-false in order to identify the ATE. However, we can take a different approach - what can we learn about the ATE without any assumptions?</p>
<p>Let us decompose the ATE into parts:</p>
<p><span class="math display">\[
\begin{align}
\tau_{ATE}  = &amp; \E(Y_{1i} - Y_{0i}) \\
&amp; \\
= &amp; \E(Y_{1i} - Y_{0i} | D_i = 1) \P(D_i = 1) \\
&amp; \quad - \E(Y_{1i} - Y_{0i}|D_i = 0)\P(D_i = 0)  &amp;&amp; (\text{def. of weighted avg.})\\
&amp; \\
= &amp; [ \color{blue}{\E(Y_i |D_i = 1)} \color{black}- \color{red}{\E(Y_{0i}|D_i = 1)} \color{black}] \P(D_i = 1) \\
&amp; \quad + [ \color{red}{\E(Y_{1i}|D_i = 0)} \color{black} - \color{blue}{\E(Y_i|D_i = 0)} \color{black}]\P(D_i = 0) &amp;&amp; (\text{observed + unobserved})
\end{align}
\]</span></p>
<p>Some of the quantities are observed (in blue), and some of the quantities are unobserved (in red). Previously, we made assumptions (conditional ignorability, common support) to fill the unobserved quantities. But, we can make actually any assumption as possible.</p>
<p><br></p>
</section>
<section id="nonparametric-bounds" class="level3">
<h3 class="anchored" data-anchor-id="nonparametric-bounds">Nonparametric Bounds</h3>
<p>One way to fill in our unobserved outcomes through the “best” and “worst” possible outcomes. This allows us to construct a plausible range of the ATE.</p>
<p>First, let us construct the worst-case scenario - the lowest possible <span class="math inline">\(\tau\)</span>.</p>
<ol type="1">
<li><span class="math inline">\(\E(Y_{0i}|D_i = 1) = Y_H\)</span>. Units in the treated <span class="math inline">\(D_i=1\)</span>, their potential outcome <span class="math inline">\(Y_{0i}\)</span> will be the highest <span class="math inline">\(Y\)</span> possible, <span class="math inline">\(Y_H\)</span>.</li>
<li><span class="math inline">\(\E(Y_{1i}|D_i = 0) = Y_L\)</span>. Units in the control <span class="math inline">\(D_i=0\)</span>, their unobserved potential outcome <span class="math inline">\(Y_{1i}\)</span> will be the lowest <span class="math inline">\(Y\)</span> possible, <span class="math inline">\(Y_L\)</span>.</li>
</ol>
<p>Thus, the lowest possible <span class="math inline">\(\tau\)</span> (sharp lower bound) is:</p>
<p><span class="math display">\[
\begin{split}
\tau_L = &amp; [ \color{blue}{\E(Y_i |D_i = 1)} \color{black}  - \color{red}{Y_H} \color{black}] \P(D_i = 1) \\
&amp; \quad + [ \color{red}{Y_L} \color{black} - \color{blue}{\E(Y_i|D_i = 0)} \color{black}]\P(D_i = 0)
\end{split}
\]</span></p>
<p>Now, let us construct the best-case scenario - the highest possible <span class="math inline">\(\tau\)</span>.</p>
<ol type="1">
<li><span class="math inline">\(\E(Y_{0i}|D_i = 1) = Y_L\)</span>. Units in the treated <span class="math inline">\(D_i=1\)</span>, their potential outcome <span class="math inline">\(Y_{0i}\)</span> will be the lowest <span class="math inline">\(Y\)</span> possible, <span class="math inline">\(Y_L\)</span>.</li>
<li><span class="math inline">\(\E(Y_{1i}|D_i = 0) = Y_H\)</span>. Units in the control <span class="math inline">\(D_i=0\)</span>, their unobserved potential outcome <span class="math inline">\(Y_{1i}\)</span> will be the highest <span class="math inline">\(Y\)</span> possible, <span class="math inline">\(Y_H\)</span>.</li>
</ol>
<p>Thus, the highest possible <span class="math inline">\(\tau\)</span> (sharp upper bound) is:</p>
<p><span class="math display">\[
\begin{split}
\tau_H = &amp; [ \color{blue}{\E(Y_i |D_i = 1)} \color{black}  - \color{red}{Y_L} \color{black}] \P(D_i = 1) \\
&amp; \quad + [ \color{red}{Y_H} \color{black} - \color{blue}{\E(Y_i|D_i = 0)} \color{black}]\P(D_i = 0)
\end{split}
\]</span></p>
<p>We know that the true <span class="math inline">\(\tau_{ATE} \in [\tau_L, \tau_H]\)</span>.</p>
<p><br></p>
</section>
<section id="monotone-treatment-selection-assumption" class="level3">
<h3 class="anchored" data-anchor-id="monotone-treatment-selection-assumption">Monotone Treatment Selection Assumption</h3>
<p>Our extreme case from above is not very useful. However, we can layer on assumptions to lower the possible <span class="math inline">\(\tau\)</span> values.</p>
<p>One assumption is the <strong>Monotone Treatment Selection (MTS)</strong> assumption. This assumption basically says that potential outcomes for units in treatment, are always higher than for those in the control.</p>
<p><span class="math display">\[
\begin{split}
&amp; \E(Y_{0i}|D_i = 0) ≤ \overbrace{\E(Y_{0i}|D_i = 1)}^{\text{unobserved}} \\
&amp; \underbrace{\E(Y_{1i} |D_i = 0)}_{\text{unobserved}} ≤ \E(Y_{1i} |D_i = 1)
\end{split}
\]</span></p>
<p>This is basically saying that selection bias is one-direction.</p>
<p>This implies a tighter sharp upper bound on <span class="math inline">\(\tau\)</span>.</p>
<p><span class="math display">\[
\begin{align}
\tau_H = &amp; [ \underbrace{\E(Y_i |D_i = 1)}_{\text{observed}}  - \color{red}{\E(Y_{0i}|D_i = 0)} \color{black}] \P(D_i = 1) \\
&amp; \quad + [ \color{red}{\E(Y_{1i}|D_i =1)} \color{black} - \underbrace{\E(Y_i|D_i = 0)}_{\text{observed}}]\P(D_i = 0) \\
= &amp; \E(Y_i|D_i = 1) - \E(Y_i|D_i = 0) &amp;&amp; (\text{def. of weighted avg.})\\
\end{align}
\]</span></p>
<p>This indicates that the upper bound of plausible <span class="math inline">\(\tau_{ATE}\)</span> values is the naive estimator of differences in observed outcomes.</p>
<p>We can also make the reverse assumption, where selection bias is in the opposite direction. This means a tighter sharp lower bound <span class="math inline">\(\underline\tau\)</span>. These assumptions help narrow our possible <span class="math inline">\(\tau_{ATE}\)</span> values, and can allow us to test if our estimated <span class="math inline">\(\hat\tau\)</span> is reasonable (within the plausible bounds).</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="implementation-in-r" class="level1">
<h1><strong>Implementation in R</strong></h1>
<p>For all methods, you will need the <em>tidyverse</em> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See how to perform each estimator in R:</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Distance Matching
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>First, let us conduct nearest neighbour matching with Mahalanobis distance by using the <em>matchit()</em> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>match_object <span class="ot">=</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> my_data,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="co">#distance matching</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for output summary</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(match_object)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, let us save the matched data with the <em>match.data()</em> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>match_data <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">match.data</span>(match_object,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">weights =</span> <span class="st">'nn_weights'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Third, we can test if matching worked by using a balance table and a love plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># balance table</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cobalt<span class="sc">::</span><span class="fu">bal.tab</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> match_data, <span class="co"># from the 2nd step</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">weights =</span> <span class="st">"nn_weights"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">disp =</span> <span class="fu">c</span>(<span class="st">"means"</span>, <span class="st">"sds"</span>))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#love plot</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>cobalt<span class="sc">::</span><span class="fu">love.plot</span>(match_object,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> my_data, <span class="co">#original dataset</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">stars =</span> <span class="st">'raw'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can estimate the treatment effect. There are two options - either using a weighted regression, or using the matching algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using weighted regression</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Y <span class="sc">~</span> D,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> match_data, <span class="co">#data from step 2</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> nn_weights)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">## using the Matching package:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">=</span> Matching<span class="sc">::</span><span class="fu">Match</span>(<span class="at">Y =</span> my_data<span class="sc">$</span>Y, <span class="co">#outcome</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">Tr =</span> my_data<span class="sc">$</span>D, <span class="co">#treatment</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">X =</span> my_data[,<span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>)], <span class="co">#covariates</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">M=</span><span class="dv">1</span>, <span class="co">#number of neighbours</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">BiasAdjust =</span> <span class="cn">TRUE</span>, <span class="co">#for biased adjustment</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">Weight =</span> <span class="dv">2</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will have the estimates that you can use.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Propensity Score Matching
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>First, we want to estimate propensity scores with a logistic regression (or a random forest):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#logistic model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pscore_model <span class="ot">=</span> <span class="fu">glm</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> my_data,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate propensity scores</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>pscore_estimate <span class="ot">=</span> <span class="fu">predict</span>(pscore_model,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                                  my_data,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let us match with propensity scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># match</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>match_object <span class="ot">=</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(D <span class="sc">~</span> pscore_estimate,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> my_data,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">distance =</span> <span class="st">"Mahalanobis"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># save matched data</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>match_data <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">match.data</span>(match_object,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">weights =</span> <span class="st">'pscore_weights'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Third, we can test if matching worked with a balance table and a love plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#balance table</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cobalt<span class="sc">::</span><span class="fu">bal.tab</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> match_data, <span class="co">#matched data from step 2</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">weights =</span> <span class="st">"pscore_weights"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">disp =</span> <span class="fu">c</span>(<span class="st">"means"</span>, <span class="st">"sds"</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#love plot</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>cobalt<span class="sc">::</span><span class="fu">love.plot</span>(match_object,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> my_data, <span class="co">#original dataset</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">addl =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">stars =</span> <span class="st">'raw'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, let us do the estimation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Y <span class="sc">~</span> D,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> match_data, <span class="co">#from step 2</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> pscore_weights)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Inverse Probability Weighting
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>First, we want to estimate propoensity scores with a logistic regression (or a random forest):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#logistic model</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pscore_model <span class="ot">=</span> <span class="fu">glm</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> my_data,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate propensity scores</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>pscore_estimate <span class="ot">=</span> <span class="fu">predict</span>(pscore_model,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, we calculate the inverse probability weights based on the formula from earlier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>ipweight <span class="ot">=</span> <span class="fu">ifelse</span>(my_data<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, <span class="co"># condition</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">1</span><span class="sc">/</span>my_data<span class="sc">$</span>pscore_estimate,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                       <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>my_data<span class="sc">$</span>pscore_estimate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can estimate the ATE, or ATT, or use a weighted regression for the ATE:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ATE estimator</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>((my_data<span class="sc">$</span>D <span class="sc">*</span> my_data<span class="sc">$</span>Y) <span class="sc">*</span> my_data<span class="sc">$</span>ipweight <span class="sc">-</span> ((<span class="dv">1</span> <span class="sc">-</span> my_data<span class="sc">$</span>D) <span class="sc">*</span> my_data<span class="sc">$</span>Y) <span class="sc">*</span> my_data<span class="sc">$</span>ipweight)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT estimator</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(my_data<span class="sc">$</span>D <span class="sc">*</span> my_data<span class="sc">$</span>Y <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">-</span> my_data<span class="sc">$</span>D) <span class="sc">*</span> my_data<span class="sc">$</span>Y <span class="sc">*</span> (my_data<span class="sc">$</span>pscore_estimate<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> my_data<span class="sc">$</span>pscore_estimate)))<span class="sc">/</span><span class="fu">sum</span>(my_data<span class="sc">$</span>D)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ATE with weighted regression</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Y <span class="sc">~</span> D, </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> my_data,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> ipweight)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
OLS Estimator
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For the OLS estimator, we can use the <em>lm_robust()</em> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">lm_robust</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> my_data)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also use the <em>fixest</em> package and the <em>feols()</em> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">feols</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> my_data,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">se =</span> <span class="st">"hetero"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fully Interacted Estimator
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For the fully interacted estimator, we can use the <em>lm_lin()</em> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>estimate <span class="ot">&lt;-</span> <span class="fu">lm_lin</span>(Y <span class="sc">~</span> D,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">covariates =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> my_data)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>