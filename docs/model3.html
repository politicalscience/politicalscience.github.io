<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Supervised Learning Methods – Political Science &amp; Political Economy</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="mathjax-config.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./model3.html">Supervised Learning Methods</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Kevin’s PSPE Resources</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
 <span class="menu-text">Quantitative Methods (Causal Inference)</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 Introductory Statistics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 Multiple Linear Regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 Classical Least Squares Theory</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 Causal Frameworks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5 Randomised Controlled Trials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 Selection on Observables</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant7.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 Instrumental Variables</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant8.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 Regression Discontinuity</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quant9.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9 Differences-in-Differences</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
 <span class="menu-text">Other Materials</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./games.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide to Game Theory</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Algebra Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calc.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculus Reference</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
 <span class="menu-text">More Statistical Models</span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model1.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic Regression Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model2.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression for Counts</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model3.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Supervised Learning Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unsupervised Learning Methods</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Factor Analysis Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model6.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Latent Trait Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model7.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Latent Class Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model9.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Structural Equation Models</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On This Page</h2>
   
  <ul>
  <li><a href="#regression-trees" id="toc-regression-trees" class="nav-link active" data-scroll-target="#regression-trees"><strong>Regression Trees</strong></a>
  <ul class="collapse">
  <li><a href="#trees-and-stratification" id="toc-trees-and-stratification" class="nav-link" data-scroll-target="#trees-and-stratification">Trees and Stratification</a></li>
  <li><a href="#determining-the-thresholds" id="toc-determining-the-thresholds" class="nav-link" data-scroll-target="#determining-the-thresholds">Determining the Thresholds</a></li>
  <li><a href="#growing-a-tree" id="toc-growing-a-tree" class="nav-link" data-scroll-target="#growing-a-tree">Growing a Tree</a></li>
  <li><a href="#benefits-and-drawbacks" id="toc-benefits-and-drawbacks" class="nav-link" data-scroll-target="#benefits-and-drawbacks">Benefits and Drawbacks</a></li>
  </ul></li>
  <li><a href="#bagging-and-random-forest" id="toc-bagging-and-random-forest" class="nav-link" data-scroll-target="#bagging-and-random-forest"><strong>Bagging and Random Forest</strong></a>
  <ul class="collapse">
  <li><a href="#bootstrap-sampling" id="toc-bootstrap-sampling" class="nav-link" data-scroll-target="#bootstrap-sampling">Bootstrap Sampling</a></li>
  <li><a href="#bagging-models" id="toc-bagging-models" class="nav-link" data-scroll-target="#bagging-models">Bagging Models</a></li>
  <li><a href="#random-forest-models" id="toc-random-forest-models" class="nav-link" data-scroll-target="#random-forest-models">Random Forest Models</a></li>
  <li><a href="#model-selection-for-prediction" id="toc-model-selection-for-prediction" class="nav-link" data-scroll-target="#model-selection-for-prediction">Model Selection for Prediction</a></li>
  <li><a href="#model-selection-for-classification" id="toc-model-selection-for-classification" class="nav-link" data-scroll-target="#model-selection-for-classification">Model Selection for Classification</a></li>
  <li><a href="#importance-statistics" id="toc-importance-statistics" class="nav-link" data-scroll-target="#importance-statistics">Importance Statistics</a></li>
  </ul></li>
  <li><a href="#causal-forests" id="toc-causal-forests" class="nav-link" data-scroll-target="#causal-forests"><strong>Causal Forests</strong></a></li>
  <li><a href="#naive-bayes-classifier" id="toc-naive-bayes-classifier" class="nav-link" data-scroll-target="#naive-bayes-classifier"><strong>Naive Bayes Classifier</strong></a></li>
  <li><a href="#implementation-in-r" id="toc-implementation-in-r" class="nav-link" data-scroll-target="#implementation-in-r"><strong>Implementation in R</strong></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Supervised Learning Methods</h1>
<p class="subtitle lead">Further Statistical Models</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>So far, we have covered traditional statistical models. In this chapter, we introduce some supervised learning data science methods, including Regression Trees, Random Forest, Causal Forests, and Naive Bayes.</p>
<p>Use the right sidebar for navigation. R-code provided at the bottom.</p>
<hr>
<section id="regression-trees" class="level1">
<h1><strong>Regression Trees</strong></h1>
<section id="trees-and-stratification" class="level3">
<h3 class="anchored" data-anchor-id="trees-and-stratification">Trees and Stratification</h3>
<p>Regression Trees are an alternative way to obtain predictions of an outcome <span class="math inline">\(y\)</span> from explanatory variables <span class="math inline">\(x\)</span>.</p>
<p>Instead of modelling how <span class="math inline">\(y\)</span> changes with every unit increase in <span class="math inline">\(x\)</span>, regression trees instead model stratification.</p>
<p>Tree-based methods will divide the independent variable <span class="math inline">\(x_j\)</span> into 2 regions, splitting <span class="math inline">\(x\)</span> at some value <span class="math inline">\(x = s\)</span>. For example, if we had an <span class="math inline">\(x\)</span> variable such that <span class="math inline">\(x \in [0, 100]\)</span>, we could split the variable at <span class="math inline">\(x = s\)</span> to create two regions: <span class="math inline">\(x^{(1)} \in [0, s]\)</span> and <span class="math inline">\(x^{(2)} \in [s, 100]\)</span>.</p>
<p>Then, tree-based methods will calculate the mean <span class="math inline">\(y\)</span> value in each region created: <span class="math inline">\(\bar y^{(1)}\)</span> and <span class="math inline">\(\bar y^{(2)}\)</span>. These means will be the predictions of <span class="math inline">\(\hat y\)</span>.</p>
<ul>
<li>If a unit <span class="math inline">\(i\)</span> has an <span class="math inline">\(x\)</span> value that falls into region <span class="math inline">\(x^{(1)} \in [0, s]\)</span>, their predicted <span class="math inline">\(\hat y = \bar y^{(1)}\)</span>.</li>
<li>If a unit <span class="math inline">\(i\)</span> has an <span class="math inline">\(x\)</span> value that falls into region <span class="math inline">\(x^{(2)} \in [s,100]\)</span>, their prediction <span class="math inline">\(\hat y = \bar y^{(2)}\)</span>.</li>
</ul>
<p><br></p>
</section>
<section id="determining-the-thresholds" class="level3">
<h3 class="anchored" data-anchor-id="determining-the-thresholds">Determining the Thresholds</h3>
<p>So we know that trees will stratify/divide our observations into groups by some threshold <span class="math inline">\(x = s\)</span>. But how do we decide which threshold <span class="math inline">\(s\)</span>,?</p>
<p>For continuous <span class="math inline">\(y\)</span> variables, to determine the threshold <span class="math inline">\(s\)</span> in which to split <span class="math inline">\(x\)</span>, the algorithm of tree regressions will find the optimal threshold <span class="math inline">\(x = s\)</span> that reduces the <strong>residual sum of squares</strong> (RSS) of the predictions the most:</p>
<p><span class="math display">\[
RSS = \sum\limits_{i=1}^n(y_i - \hat y_i)^2
\]</span></p>
<p>Essentially, the computer tests every possible threshold value of <span class="math inline">\(x_j = s\)</span>, and finds the threshold that reduces the sum of squares the most.</p>
<p>For binary <span class="math inline">\(y\)</span> variables, trees will determine the threshold <span class="math inline">\(s\)</span> in which to split <span class="math inline">\(x\)</span>, based on the threshold <span class="math inline">\(x=s\)</span> that reduces the <strong>classification error rate</strong>.</p>
<p>The classification error is essentially how many predictions <span class="math inline">\(\hat y\)</span> do not match to the actual <span class="math inline">\(y\)</span>.</p>
<p><br></p>
</section>
<section id="growing-a-tree" class="level3">
<h3 class="anchored" data-anchor-id="growing-a-tree">Growing a Tree</h3>
<p>The process of growing a tree is as follows. Assume now we have more than one explanatory variable.</p>
<ol type="1">
<li>Test all possible thresholds <span class="math inline">\(x_j = s\)</span> for each <span class="math inline">\(x_j \in \{x_1, \dots, x_k\}\)</span>.</li>
<li>Identify the specific variable <span class="math inline">\(x_p \in \{x_2, \dots, x_k\}\)</span> which has a specific threshold <span class="math inline">\(x_p = s^*\)</span> that has the greatest reduction in residual sum of squares (or classification error rate), for all combinations of <span class="math inline">\(x_j\)</span> and threshold <span class="math inline">\(s\)</span>.</li>
<li>Now, divide that specific <span class="math inline">\(x_p\)</span> at that specific threshold <span class="math inline">\(s^*\)</span>, creating two regions <span class="math inline">\(x_p^{(1)}, x_p^{(2)}\)</span>.</li>
<li>Now, we repeat the process of testing all possible thresholds <span class="math inline">\(x_j = s\)</span> for each <span class="math inline">\(x_j \in \{x_1, \dots, x_k \}\)</span> and finding the specific variable-threshold <span class="math inline">\(x_m = s^{**}\)</span> that results the in the greatest reduction in RSS (or classification error rate) within <span class="math inline">\(x_p^{(1)}\)</span>. Create 2 more groups from within <span class="math inline">\(x_p^{(1)}\)</span>.</li>
<li>Then, do the same for <span class="math inline">\(x_p^{(2)}\)</span>. Create 2 more groups from with <span class="math inline">\(x_p^{(2)}\)</span>.</li>
<li>Keep on going, finding the variable-thresholds which reduce the RSS the most from each previous subregion we have created.</li>
<li>Continue doing this until some stopping criteria. Find the average <span class="math inline">\(y\)</span> in each of the groups you have, and those are the predicted <span class="math inline">\(\hat y\)</span>.</li>
</ol>
<p>It is possible for a variable to occur multiple times with different thresholds.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example of Growing a Tree
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Below is an example of growing a tree:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3372306608.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>We can see that the first (top) split is in the variable <em>taxpercent</em>, at threshold 34.2935. That means that specific variable-threshold split reduced the RSS the most of any variable-threshold combination.</p>
<p>Notice how after the first split, we only divide each subregion. We do not go back to the top/whole data set.</p>
<p>Notice how <em>taxpercent</em> re-appears again on the right side of the tree. It is possible for a variable to occur multiple times.</p>
<p>At the end, you can see the numbers at the bottom. These are called leaves, and are the final categories/groups of the tree with their mean <span class="math inline">\(y\)</span> labelled. Those mean <span class="math inline">\(y\)</span> will be the predictions for each observation that falls into that group.</p>
</div>
</div>
</div>
<p>The earlier a variable is split, the more <em>influential</em> the variable is. We will discuss this idea further later in the chapter.</p>
<p><br></p>
</section>
<section id="benefits-and-drawbacks" class="level3">
<h3 class="anchored" data-anchor-id="benefits-and-drawbacks">Benefits and Drawbacks</h3>
<p>Simple regression trees have both benefits and drawbacks.</p>
<p>One of the best things about decision trees is that they incorporate interactions between variables. Lower-level splits of variables are interacting with higher-level splits of variables. This allows regression trees to be excellent for non-linear predictions.</p>
<p>Regression trees are also great for visualisation, and are quite easy to explain visually without invoking complex statistics or mathematics.</p>
<p>The downside of regression trees is that they have extremely high variance. If you just slightly change the data, your predicted results will be completely different, and even the order of variables and thresholds will completely change. This is called <strong>overfitting</strong>.</p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The Problem of Overfitting
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">

</div>
</div>
</div>
<p>This is not a good thing - after all, we want to be able to predict unseen data. Overfitting causes simple regression trees to be poor predictors on their own.</p>
<p>Thus, we almost never use simple regression trees for prediction. We tend to use more advanced models, Random Forest and Bagging, which build on regression trees, but solve this issue of overfitting.</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="bagging-and-random-forest" class="level1">
<h1><strong>Bagging and Random Forest</strong></h1>
<section id="bootstrap-sampling" class="level3">
<h3 class="anchored" data-anchor-id="bootstrap-sampling">Bootstrap Sampling</h3>
<p>While regression trees have some benefits, they suffer from overfitting and high variance. <strong>Bootstrap Aggregation</strong> is a procedure for reducing the variance of a statistical learning method.</p>
<p>This procedure builds on a simple statistical idea: in a set of <span class="math inline">\(n\)</span> samples <span class="math inline">\(Z_1, \dots, Z_n\)</span> each with variance <span class="math inline">\(\sigma^2\)</span>, the variance of the means <span class="math inline">\(\bar Z\)</span> of all the samples is <span class="math inline">\(\frac{\sigma^2}{n}\)</span>. Since <span class="math inline">\(n\)</span> is in the denominator, that implies increasing the number of samples <span class="math inline">\(n\)</span> will reduce the variance of our predictions.</p>
<p>However, we typically only have one sample of data. How can we increase <span class="math inline">\(n\)</span> if we only have one sample? The answer is <strong>Bootstrap Sampling</strong>. Essentially, we sample with replacement from our original sample.</p>
<p>To create a bootstrap sample, we choose 1 observation at random from our original sample. We add that observation to our bootstrap sample, and replace it back into our original sample. Then, we draw another observation, add it to our bootstrap sample, and replace it back. We do this <span class="math inline">\(n\)</span> times (<span class="math inline">\(n\)</span> being the sample size of our sample).</p>
<p>If we do this procedure multiple times, we will end up with a few similar, but slightly different data sets. We are essentially replicating the process of obtaining new data sets, without gathering more data. Now, with our multiple data sets, we can use bootstrap aggregation to reduce our variance.</p>
<p><br></p>
</section>
<section id="bagging-models" class="level3">
<h3 class="anchored" data-anchor-id="bagging-models">Bagging Models</h3>
<p><strong>Bagging</strong> models apply bootstrap sampling to tree regressions.</p>
<ol type="1">
<li>We first generate <span class="math inline">\(B\)</span> number of bootstrap samples.</li>
<li>Then, we train a tree on each different sample <span class="math inline">\(b\)</span>, creating a prediction function <span class="math inline">\(f_b(x) = \hat y_b\)</span> for each sample, which specifies what values of <span class="math inline">\(x\)</span> result in what predicted <span class="math inline">\(\hat y\)</span> according to the tree.</li>
<li>Then we average all of the sample predictions together to obtain our final prediction function <span class="math inline">\(f_{bag}(x)\)</span>.</li>
</ol>
<p><span class="math display">\[
f_{bag}(x) = \frac{1}{B}\sum\limits_{b=1}^Bf_b(x)
\]</span></p>
<p>Bagging reduces the variance of trees, and is one of the most accurate prediction methods, frequently outperforming both linear and non-linear methods.</p>
<p>However, bagging is still not perfect. This is because bagging trees are heavily correlated: in general, the trees will have the same top-level <span class="math inline">\(x_p\)</span> variable, especially if there is one very strong predictor in our explanatory variables.</p>
<p>This is an issue - highly correlated trees, even if averaged, do not reduce the variance as much as we might need. This is where the next class of models, Random Forests, come in.</p>
<p><br></p>
</section>
<section id="random-forest-models" class="level3">
<h3 class="anchored" data-anchor-id="random-forest-models">Random Forest Models</h3>
<p>Bagging has an issue of having highly correlated trees, which may not reduce variance as much as we desire. <strong>Random Forests</strong> solve this issue by not only bootstrapping observations like Bagging does, but also sampling a subset of explanatory variables for each tree.</p>
<p>For example, let us say you a set of explanatory variables <span class="math inline">\(\mathcal X = \{x_1, \dots  x_k\}\)</span>. For every bootstrap sample of observations <span class="math inline">\(b\)</span> that we did in bagging, Random forest will also sample a subset of explanatory variables <span class="math inline">\(\mathcal X_b\)</span>, which contains only <span class="math inline">\(g&lt;k\)</span> number of explanatory variables.</p>
<p>This means that each tree Random Forest produces only has a subset of <span class="math inline">\(g\)</span> explanatory variables, not the total number of <span class="math inline">\(k\)</span> explanatory variables. This means that sometimes, influential variables <span class="math inline">\(x_p\)</span> will not be included in the subset <span class="math inline">\(\mathcal X_b\)</span>, which will allow for other predictors to get a chance to shine.</p>
<p>Thus, Random Forest will have less correlated trees, and thus, will typically have more accurate predictions.</p>
<p>Generally, the size of the subset of explanatory variables <span class="math inline">\(\mathcal X_b\)</span> will typically be <span class="math inline">\(g=\sqrt{k}\)</span>, the square root of the total number of explanatory variables. However, you can play around with this (discussed in the next section).</p>
<p><br></p>
</section>
<section id="model-selection-for-prediction" class="level3">
<h3 class="anchored" data-anchor-id="model-selection-for-prediction">Model Selection for Prediction</h3>
<p>There are a few choices you must make when specifying the model you are using.</p>
<ol type="1">
<li>Should you use Random Forest or Bagging? Typically, Random Forest is better, but this is not always the case.</li>
<li>If you do choose Random Forest, what size of the subset of explanatory variables <span class="math inline">\(\mathcal X_b\)</span> should you use? Typically, the standard is to use the square root of the number of explanatory variables, but this is not a fixed rule.</li>
</ol>
<p><strong>Mean of squared residuals</strong> is a general measure of how well the model performed. It is the mean of the squared errors, where the errors are the differences between the actual dataset <span class="math inline">\(y_i\)</span> value and the predicted <span class="math inline">\(\hat y_i\)</span> value.</p>
<p>In R, the mean of squared residuals metric is calculated on testing data - testing the model on units that were not included in a specific bootstrap sample. Thus, this is a good measure of how predictive your model is, without worrying about overfitting.</p>
<p>You should test all different possibilities of model selection choices, and see which one reduces the mean of squared residuals the most.</p>
<p><br></p>
</section>
<section id="model-selection-for-classification" class="level3">
<h3 class="anchored" data-anchor-id="model-selection-for-classification">Model Selection for Classification</h3>
<p>For classification tasks, you have the same decisions (bagging vs.&nbsp;random forest, what size <span class="math inline">\(\mathcal X_b\)</span>) as prediction tasks.</p>
<p>The simplest metric to help you make the decision is the <strong>error rate</strong>. This is simply the percentage of observations the model got wrong (predicted one category when it should have been the other).</p>
<p>We can also dig into more detail.</p>
<ul>
<li>The <strong>False Positive Rate</strong> is the observations that are <span class="math inline">\(y=0\)</span>, but our model predicted incorrectly as <span class="math inline">\(\hat y = 1\)</span>.</li>
<li>The <strong>False Negative Rate</strong> is the observations that are <span class="math inline">\(y=1\)</span>, but our model predicted incorrectly as <span class="math inline">\(\hat y = 0\)</span>.</li>
</ul>
<p>The inverses of false positives/negatives are specificity and sensitivity:</p>
<ul>
<li><strong>Specificity</strong> is the percentage of observations that are <span class="math inline">\(y=0\)</span>, that our model correctly predicted as <span class="math inline">\(\hat y =0\)</span>.</li>
<li><strong>Sensitivity</strong> is the percentage of observations that are <span class="math inline">\(y=1\)</span>, that our model correctly predicted as <span class="math inline">\(\hat y = 1\)</span>.</li>
</ul>
<p>The metric on which to focus on depends on our goals of classification. Choosing the right model requires some subjectivity. For example, if we are trying to predict if a patient has a serious disease, we probably want more false positives rather than under-detecting people who are actually sick. But for judicial systems, since we do not want to put an innocent person in jail, we might prefer lower false positives, and more false negatives.</p>
<p><br></p>
</section>
<section id="importance-statistics" class="level3">
<h3 class="anchored" data-anchor-id="importance-statistics">Importance Statistics</h3>
<p>One of the downsides of Bagging and Random Forest is that they are harder to interpret than Regression Trees.</p>
<p>Regression Trees produce a nice diagram, with the most important variables near the top. However, Bagging and Random Forest average hundreds or thousands of different trees, so we cannot really draw a diagram out.</p>
<p>This is where importance statistics comes in. To calculate importance, we “remember” the reduction in RSS (or error rate) every time we split a tree, for every bagging sample <span class="math inline">\(b\)</span>. Then, we figure out which variables on average reduce the RSS (or error rate) the most.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-364907520.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Above is an example of the importance plot. This allows us to determine which explanatory variables are the most influential in determining the predictions, which can be useful in interpretation.</p>
<p><br></p>
<p><br></p>
<hr>
</section>
</section>
<section id="causal-forests" class="level1">
<h1><strong>Causal Forests</strong></h1>
<p><br></p>
<p><br></p>
<hr>
</section>
<section id="naive-bayes-classifier" class="level1">
<h1><strong>Naive Bayes Classifier</strong></h1>
<p><br></p>
<p><br></p>
<hr>
</section>
<section id="implementation-in-r" class="level1">
<h1><strong>Implementation in R</strong></h1>
<p>You will need the <em>randomForest</em> and <em>tidyverse</em> packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For replication purposes (if you are publishing a paper), you may also want to set a random seed, which will ensure your bootstrap and variable sampling remains consistent in replication.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>) <span class="co">#any number will work</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bagging Model
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You can train a bagging model with the <em>randomForest()</em> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> mydata,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.action =</span> na.omit,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mtry =</span> <span class="dv">4</span>, <span class="co">#equal to k</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#call object to see output</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output will contain summary statistics.</p>
<p>Note: you can also do <span class="math inline">\(Y \sim .\)</span> in the formula. The <span class="math inline">\(.\)</span> symbolises that you want to include all other variables not <span class="math inline">\(Y\)</span> within your dataframe into your model. This speeds up the process of writing every single explanatory variable out.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Random Forest Model
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You can train a random forest model with the <em>randomForest()</em> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(Y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3 <span class="sc">+</span> x4,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> mydata,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.action =</span> na.omit,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mtry =</span> <span class="dv">2</span>, <span class="co">#equal to sqrt of k</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#call object to see output</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output will contain summary statistics.</p>
<p>Note: you can also do <span class="math inline">\(Y \sim .\)</span> in the formula. The <span class="math inline">\(.\)</span> symbolises that you want to include all other variables not <span class="math inline">\(Y\)</span> within your dataframe into your model. This speeds up the process of writing every single explanatory variable out.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Predictions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>You probably want to make predictions with your model (that is kind of the point of these models).</p>
<p>We can use the <em>predict()</em> function to generate predictions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mypredictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> my_new_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>my_new_data</em> is a dataframe with a bunch of explanatory variable values (for every explanatory variable) for a collection of observations, that you wish to predict <span class="math inline">\(\hat y\)</span> for.</p>
<p><em>model</em> is the name of the object in which you stored your trained model to.</p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Importance Plot
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To see the importance of each explanatory variable, we can use the <em>varImpPlot()</em> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(model,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">main =</span> <span class="st">"Title of the Graph"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">type =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Do not change type = 2. That specifies something technical that you do not need to worry about.</p>
</div>
</div>
</div>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>