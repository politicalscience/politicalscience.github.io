<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Quasi-Experimental Methods – Statistics for Political Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<link href="./time.html" rel="next">
<link href="./nonlinear.html" rel="prev">
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="mathjax-config.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./glm.html">Part II: Applied Statistics</a></li><li class="breadcrumb-item"><a href="./identify.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Quasi-Experimental Methods</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistics for Political Science</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part I: Theoretical Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Random Variables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical Inference</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mle.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Maximum Likelihood</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ols.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Least Squares Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Causal Inference</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part II: Applied Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Generalised Linear Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-Linear Methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./identify.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Quasi-Experimental Methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Methods</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Multivariate Methods</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">8.1</span> Overview</a></li>
  <li><a href="#non-compliance-designs" id="toc-non-compliance-designs" class="nav-link" data-scroll-target="#non-compliance-designs"><span class="header-section-number">8.2</span> Non-Compliance Designs</a></li>
  <li><a href="#sharp-regression-discontinuity" id="toc-sharp-regression-discontinuity" class="nav-link" data-scroll-target="#sharp-regression-discontinuity"><span class="header-section-number">8.3</span> Sharp Regression Discontinuity</a></li>
  <li><a href="#fuzzy-regression-discontinuity" id="toc-fuzzy-regression-discontinuity" class="nav-link" data-scroll-target="#fuzzy-regression-discontinuity"><span class="header-section-number">8.4</span> Fuzzy Regression Discontinuity</a></li>
  <li><a href="#examiner-designs" id="toc-examiner-designs" class="nav-link" data-scroll-target="#examiner-designs"><span class="header-section-number">8.5</span> Examiner Designs</a></li>
  <li><a href="#shift-share-instruments" id="toc-shift-share-instruments" class="nav-link" data-scroll-target="#shift-share-instruments"><span class="header-section-number">8.6</span> Shift-Share Instruments</a></li>
  <li><a href="#differences-in-differences" id="toc-differences-in-differences" class="nav-link" data-scroll-target="#differences-in-differences"><span class="header-section-number">8.7</span> Differences-in-Differences</a></li>
  <li><a href="#selection-on-observables" id="toc-selection-on-observables" class="nav-link" data-scroll-target="#selection-on-observables"><span class="header-section-number">8.8</span> Selection on Observables</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./glm.html">Part II: Applied Statistics</a></li><li class="breadcrumb-item"><a href="./identify.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Quasi-Experimental Methods</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Quasi-Experimental Methods</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In the <a href="./causal.html">chapter 5</a>, we introduced the frameworks of causal inference, and how randomisation can establish causality.</p>
<p>However, in the social sciences, we cannot always run randomised experiments where we control the assignment of treatment. In fact, in most scenarios, we have to rely on observational data. In this chapter, we introduce methods to identify causal effects when randomisation is not possible.</p>
<p><br></p>
<section id="overview" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="overview"><span class="header-section-number">8.1</span> Overview</h2>
<p>In <a href="./causal.html">chapter 5</a>, we discussed how randomised experiments can establish causality. However, in the social sciences, randomised experiments where researchers control treatment assignment are not always possible to implement. Sometimes even with randomisation, something goes wrong, and we need another way to establish causality.</p>
<p>As a result, a series of quasi-experimental designs have been developed in order to estimate causal effects. These designs range in terms of credibility, and can generally only be implemented in certain scenarios where the real-world aligns with the specific design. The main designs, in order of credibility, are:</p>
<table class="table-bordered caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 65%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th>Design</th>
<th>When to Use</th>
<th>Estimands</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="#non-compliance-designs">Non-Compliance Designs</a></td>
<td>When we have a randomised experiment, but some individuals do not comply with the treatment we assigned with them.</td>
<td>LATE, ITT</td>
</tr>
<tr class="even">
<td><a href="#sharp-regression-discontinuity">Sharp Regression Discontinuity</a></td>
<td>When treatment is assigned in the real-world by some cut-off value of some variable.</td>
<td>LATE</td>
</tr>
<tr class="odd">
<td><a href="#fuzzy-regression-discontinuity">Fuzzy Regression Discontinuity</a></td>
<td>When treatment is assigned in the real-world by some cut-off value of some variable, but there is some non-compliance.</td>
<td>LATE</td>
</tr>
<tr class="even">
<td><a href="#examiner-designs">Examiner Instruments</a></td>
<td>When treatment assignment is influenced by the quasi-random assignment of individuals to decision makers (examiners), such as judges, doctors, caseworkers, etc.</td>
<td>LATE</td>
</tr>
<tr class="odd">
<td><a href="#shift-share-instruments">Shift-Share Instruments</a></td>
<td>When treatment is assigned based on some exposure (share) to some exogenous/random shock (shift).</td>
<td>LATE</td>
</tr>
<tr class="even">
<td><a href="#differences-in-differences">Differences-in-Differences</a></td>
<td>When there is variation in time of implementation of treatments between areas/units.</td>
<td>ATT</td>
</tr>
<tr class="odd">
<td><a href="#selection-on-observables">Selection on Observables</a></td>
<td>When treatment is believed to be assigned based on a set of variables (covariates) that we can observe.</td>
<td>ATE, ATT</td>
</tr>
</tbody>
</table>
<p>We will explore each of these designs in more details below.</p>
<p><br></p>
</section>
<section id="non-compliance-designs" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="non-compliance-designs"><span class="header-section-number">8.2</span> Non-Compliance Designs</h2>
<p>When we assign individuals to treatment/control in <a href="./causal.html#randomised-experiments">randomised experiments</a>, we often cannot guarantee that individuals will actually follow through with treatment. Let us assume an <strong>encouragement</strong> <span class="math inline">\(Z_t \in \{0, 1\}\)</span>, which is our treatment assignment. Then, we have the <strong>treatment</strong> variable <span class="math inline">\(D_t \in \{0,1\}\)</span>, which is someone who actually took the treatment or not. Given this framework, we can divide all units <span class="math inline">\(i\)</span> into 4 categories:</p>
<ol type="1">
<li>Compliers: People who comply with encouragement <span class="math inline">\(Z_i\)</span>. Their <span class="math inline">\(Z_i = D_i\)</span>.</li>
<li>Always-takers: People who no matter what encouragement <span class="math inline">\(Z_i\)</span> is, always take treatment.</li>
<li>Never-takers: People who no matter their encouragement <span class="math inline">\(Z_i\)</span> is, never take treatment.</li>
<li>Defiers: People who do the opposite of encouragement <span class="math inline">\(Z_i\)</span>, so always <span class="math inline">\(D_i ≠ Z_i\)</span>.</li>
</ol>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Principle Strata
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We can visually show what will happen with all 4 types of people in a table, called the principal strata:</p>
<table class="table-bordered caption-top table">
<tbody>
<tr class="odd">
<td></td>
<td><span class="math inline">\(Z_i = 1\)</span></td>
<td><span class="math inline">\(Z_i = 0\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(D_i = 1\)</span></td>
<td>Complier/Always-Taker</td>
<td>Defier/Always-Taker</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(D_i = 0\)</span></td>
<td>Defier/Never-Taker</td>
<td>Complier/Never-Taker</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The idea of the non-compliance designs is to use our encouragement/treatment assignment <span class="math inline">\(Z\)</span> as an <a href="./ols.html#instrumental-variables-estimator">instrument</a> for <span class="math inline">\(D\)</span> - actually taking the treatment.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Assumptions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Identification</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Graphical Identification</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>There are 4 assumptions to the non-compliance designs:</p>
<ol type="1">
<li><strong>Relevance</strong>: <span class="math inline">\(Z\)</span> must be correlated to <span class="math inline">\(D\)</span>, i.e.&nbsp;<span class="math inline">\(Cov(Z,D)≠0\)</span>. Or in other words, compilers must exist, or else, encouragement <span class="math inline">\(Z\)</span> would not affect treatment <span class="math inline">\(D\)</span>.</li>
<li><strong>Ignorability/Exogneity</strong>: There is no backdoor path between <span class="math inline">\(Z\)</span> and <span class="math inline">\(D\)</span>, and no backdoor path between <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span> (we can do controls/selection on observables to account for this). This is generally met if our <span class="math inline">\(Z\)</span> in our non-compliance design is randomly assigned.</li>
<li><strong>Exclusions Restriction</strong>: <span class="math inline">\(Z\)</span> must only have an effect on <span class="math inline">\(Y\)</span> through <span class="math inline">\(D\)</span>. <span class="math inline">\(Z\)</span> must not have any independent effect on <span class="math inline">\(Y\)</span>.</li>
<li><strong>Monotonicity</strong>: There are no defiers - people who do the opposite of their encouragement <span class="math inline">\(Z\)</span>, no matter what <span class="math inline">\(Z\)</span> they get.</li>
</ol>
<p>We have two estimands of interest. The <strong>Intent to Treat (ITT)</strong> is the ATE of <span class="math inline">\(Z\)</span> on <span class="math inline">\(Y\)</span>. This is the effect of encouragement:</p>
<p><span class="math display">\[
\tau_{ITT} = \E(Y_t|Z_t = 1) - \E(Y_t | Z_t = 0)
\]</span></p>
<p>However, the ITT does not tell us anything about the effect of <span class="math inline">\(D\)</span> (the treatment), only <span class="math inline">\(Z\)</span> (the encouragement). The <strong>Local Average Treamtment Effect (LATE)</strong> provides the effect of the treatment <span class="math inline">\(D\)</span> on <span class="math inline">\(Y\)</span> for compliers (so the ITT or ATE for compliers):</p>
<p><span class="math display">\[
\tau_{LATE} = \E(\tau_t | \mathrm{compliers})
\]</span></p>
<p>The LATE is generally not equivalent to the ATT or the ATE.</p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>The ITT itself is identifiable under exogeneity/ignorability alone, since <span class="math inline">\(Z\)</span> is randomly assigned in non-compliance designs.</p>
<p>To identify the LATE, we will need all 4 assumptions. Let us define <span class="math inline">\(c\)</span> as compliers, <span class="math inline">\(a\)</span> as always-takers, <span class="math inline">\(n\)</span> as never-takers, and <span class="math inline">\(d\)</span> as defiers. We can break down the ITT into a weighted average:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c) + \tau_{ITT}^a \P(a) + \tau_{ITT}^n \P(n) + \tau_{ITT}^d \P(d)
\]</span></p>
<p>We know that under our assumption of monotonicity, we assume no defiers, so the probability of a defier is <span class="math inline">\(\P(d) = 0\)</span>:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c) + \tau_{ITT}^a \P(a) + \tau_{ITT}^n \P(n)
\]</span></p>
<p>Our exclusions restriction says that <span class="math inline">\(Z\)</span> has no independent effect on <span class="math inline">\(Y\)</span>. The ITT is the relationship between <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span>. But since always-takers and never-takers ignore <span class="math inline">\(Z\)</span> when deciding treatment, <span class="math inline">\(Z\)</span> has no effect of them on <span class="math inline">\(Y\)</span>. Thus, we can further simplify:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c)
\]</span></p>
<p>Remember that the <span class="math inline">\(\tau_{ITT}\)</span> for compliers, <span class="math inline">\(\tau_{ITT}^c = \tau_{ATE}\)</span>. So, let us isolate it to get:</p>
<p><span class="math display">\[
\tau_{LATE} = \frac{\tau_{ITT}}{\P(c)} \ = \ \frac{\E(Y_i | Z_i = 1) - \E(Y_i | Z_i = 0)}{\E(D_i | Z_i = 1) - \E(D_i | Z_i = 0)}
\]</span></p>
<p>For estimation, we could our sample equivalents in. Alternatively, we can use 2SLS (shown below), which produces equivalent estimates.</p>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p>The typical <span class="math inline">\(Z\)</span> setup in instrumental variables (and the non-compliance design) is:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-1350479199.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:35.0%"></p>
</figure>
</div>
<p>Since we use only the compliers (the part of <span class="math inline">\(D\)</span> that is explained by <span class="math inline">\(Z\)</span>) for the LATE, <span class="math inline">\(Z\)</span> determines <span class="math inline">\(D\)</span>, and not <span class="math inline">\(U\)</span>. Thus, we have broken the link <span class="math inline">\(U \rightarrow D\)</span>, thus eliminating our confounder problem. The weaknesses of the design are the numerous possible violations:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-390858332.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
<p>In a non-compliance design, since <span class="math inline">\(Z\)</span> is randomly assigned, ignorability is generally not a huge concern. Relevance is generally met assuming we have compliers. Our main concern is the exclusions restriction.</p>
</div>
</div>
</div>
<p>To estimate the LATE in a non-compliance design, we typically use the 2-stage least squares estimator, as was detailed <a href="./ols.html#instrumental-variables-estimator">previously</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>late <span class="ot">&lt;-</span> fixest<span class="sc">::</span><span class="fu">feols</span>(Y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> D <span class="sc">~</span> Z, <span class="at">data =</span> mydata, <span class="at">se =</span> <span class="st">"hetero"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The 2SLS estimator (and IV estimator) are biased in small sample sizes, but asymptotically consistent, so we should be more careful when dealing with small samples.</p>
<p>When interpreting the LATE, we must be careful. The LATE is only the causal effect of taking the treatment for compliers. However, we cannot say anything about non-compliers, and we must be careful about generalising. We generally do not know who the compliers are as well, and different <span class="math inline">\(Z\)</span> can result in different compliers.</p>
<p><br></p>
</section>
<section id="sharp-regression-discontinuity" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="sharp-regression-discontinuity"><span class="header-section-number">8.3</span> Sharp Regression Discontinuity</h2>
<p><br></p>
</section>
<section id="fuzzy-regression-discontinuity" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="fuzzy-regression-discontinuity"><span class="header-section-number">8.4</span> Fuzzy Regression Discontinuity</h2>
<p><br></p>
</section>
<section id="examiner-designs" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="examiner-designs"><span class="header-section-number">8.5</span> Examiner Designs</h2>
</section>
<section id="shift-share-instruments" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="shift-share-instruments"><span class="header-section-number">8.6</span> Shift-Share Instruments</h2>
</section>
<section id="differences-in-differences" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="differences-in-differences"><span class="header-section-number">8.7</span> Differences-in-Differences</h2>
<p><br></p>
</section>
<section id="selection-on-observables" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="selection-on-observables"><span class="header-section-number">8.8</span> Selection on Observables</h2>
<p>Selection on Observables is an way to get rid of the selection bias problem by <a href="./causal.html#confounders">controlling for a set of confounders</a> <span class="math inline">\(\mathcal X\)</span> to <a href="./causal.html#structural-causal-models">block backdoor paths</a> and isolate the relationship between <span class="math inline">\(D \rightarrow Y\)</span>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Assumptions</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Identification of ATE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Identification of ATT</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>There are two assumptions for selection on observables:</p>
<p><strong>Conditional Ignorability</strong> (also called conditional independence) means that among units <span class="math inline">\(i\)</span> with identical confounder values <span class="math inline">\(\mathcal X_i\)</span>, treatment <span class="math inline">\(D_i\)</span> is as-if randomly assigned. Potential outcomes are independent from treatment within each specific confounder value <span class="math inline">\(\mathcal X_i = x\)</span>.</p>
<p><span class="math display">\[
(\pc, \pt) \ind D_t \ | \ \set X_t = x, \ \forall \ x \in \set X
\]</span></p>
<p>This assumption implies that given any value of confounders <span class="math inline">\(\set X_t = x\)</span>, potential outcomes are equivalent between treatment and control groups:</p>
<p><span id="eq-selectiononobservables"><span class="math display">\[
\begin{align}
&amp; \E(\pc|D_t = 1, \set X_t = x) \ = \ \E(\pc|D_t = 0, \set X_t = x) \ = \ \E(\pc|\set X_t = x) \\
&amp; \E(\pt|D_t = 1, \set X_t = x) \ = \ \E(\pt|D_t = 0, \set X_t = x) \ = \ \E(\pt|\set X_t = x)
\end{align}
\tag{8.1}\]</span></span></p>
<p><strong>Common Support</strong> is the second assumption, and it states for any unit <span class="math inline">\(t\)</span> with any value of <span class="math inline">\(\mathcal X_t\)</span>, they have a non-zero probability they can be assigned to both control and treatment.</p>
<p>A few tips for selection controls in set <span class="math inline">\(\set X\)</span>:</p>
<ul>
<li>Good controls are confounders <span class="math inline">\(X\)</span> who cause <span class="math inline">\(D\)</span> (i.e.&nbsp;<span class="math inline">\(X \rightarrow D\)</span>), and are associated with <span class="math inline">\(Y\)</span>. We want to control for all of these.</li>
<li>Bad controls include any variable that is caused by <span class="math inline">\(D\)</span>, i.e.&nbsp;<span class="math inline">\(D \rightarrow W\)</span>. We do not need to control for this because <span class="math inline">\(W\)</span> isn’t causing selection into <span class="math inline">\(D\)</span>, it is actually itself caused by <span class="math inline">\(D\)</span>. Another bad control is a variable <span class="math inline">\(Z\)</span> that only causes <span class="math inline">\(D\)</span>, and not <span class="math inline">\(Y\)</span>. This reduces the variation in <span class="math inline">\(D\)</span>, which may amplify any other confounders unaccounted for.</li>
<li>Neutral controls are variables that only cause <span class="math inline">\(Y\)</span> and are not associated with <span class="math inline">\(D\)</span>. They do not affect the causal identification, but can reduce our standard errors.</li>
</ul>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>Using these assumptions, we can first identify the CATE, which will allow us to identify the ATE. Let us first start with the definition of CATE (<a href="causal.html#def-cate" class="quarto-xref">definition&nbsp;<span>5.6</span></a>):</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt - \pc \ | \ \set X_t = x) \\
&amp; = \E(\pt | \set X_t = x) - \E(\pc|\set X_t = x) \\
\end{align}
\]</span></p>
<p>Now, from the properties implied by conditional ignorability given in <a href="#eq-selectiononobservables" class="quarto-xref">eq.&nbsp;<span>8.1</span></a>, we get</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt|D_i = 1, \set X_t = x) - \E(\pc|D_i = 0, \set X_t = x) \\
&amp; = \E(Y_{t}|D_t = 1, \mathcal X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x) \\
\end{align}
\]</span></p>
<p>And the second step above is because <span class="math inline">\(\pt|D_i = 1\)</span> and <span class="math inline">\(\pc|D_i = 0\)</span> are observable outcomes (<a href="causal.html#def-observedoutcomes" class="quarto-xref">definition&nbsp;<span>5.7</span></a>). Thus, with independence, we can identify the CATE with just observed outcomes.</p>
<p>Let us consider the definition of the ATE, which is <span class="math inline">\(\E(\pt - \pc)\)</span>. From the definition of expectation given in <a href="random.html#def-exp" class="quarto-xref">definition&nbsp;<span>1.2</span></a>, we can rewrite the ATE as</p>
<p><span class="math display">\[
\tau_{ATE} = \int\tau_{CATE}(x) \P(\mathcal x) dy
\]</span></p>
<p>Which is a weighted average. We established above that we can identify the CATE. Thus, we can plug the CATE into the ATE to get our identified ATE:</p>
<p><span class="math display">\[
\tau_{ATE} = \int [\E(Y_{t}|D_t = 1, \set X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x)] \P(x) dy
\]</span></p>
<p>And all the values in this equation are observed outcomes <span class="math inline">\(Y_t\)</span>, meaning if we control for set of confounders <span class="math inline">\(\mathcal X\)</span>, our correlation becomes a causal effect.</p>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<p>Using these assumptions, we can first identify the CATE, which will allow us to identify the ATT. Let us first start with the definition of CATE (<a href="causal.html#def-cate" class="quarto-xref">definition&nbsp;<span>5.6</span></a>):</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt - \pc \ | \ \set X_t = x) \\
&amp; = \E(\pt | \set X_t = x) - \E(\pc|\set X_t = x) \\
\end{align}
\]</span></p>
<p>Now, from the properties implied by conditional ignorability given in <a href="#eq-selectiononobservables" class="quarto-xref">eq.&nbsp;<span>8.1</span></a>, we get</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt|D_i = 1, \set X_t = x) - \E(\pc|D_i = 0, \set X_t = x) \\
&amp; = \E(Y_{t}|D_t = 1, \mathcal X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x) \\
\end{align}
\]</span></p>
<p>And the second step above is because <span class="math inline">\(\pt|D_i = 1\)</span> and <span class="math inline">\(\pc|D_i = 0\)</span> are observable outcomes (<a href="causal.html#def-observedoutcomes" class="quarto-xref">definition&nbsp;<span>5.7</span></a>). Thus, with independence, we can identify the CATE with just observed outcomes.</p>
<p>Let us consider the definition of the ATT, which is <span class="math inline">\(\E(\pc = \pt | D_i = 1)\)</span>. From the definition expectation given in <a href="random.html#def-exp" class="quarto-xref">definition&nbsp;<span>1.2</span></a>, we can rewrite the ATT as</p>
<p><span class="math display">\[
\tau_{ATT} = \int \tau_{CATE}(x) \P(x|D_t = 1) dy
\]</span></p>
<p>Which is a weighted average. We established above that we can identify the CATE. Thus, we can plug CATE into the ATE to get our identified ATT:</p>
<p><span class="math display">\[
\tau_{ATT} = \int [\E(Y_{t}|D_t = 1, \set X_t = x) - \E(Y_{t}|D_t = 0, \mathcal X_t = x)] \P(x|D_t = 1) dy
\]</span></p>
<p>And all the values in this equation are observed outcomes <span class="math inline">\(Y_t\)</span>, meaning if we control for set of confounders <span class="math inline">\(\mathcal X\)</span>, our correlation becomes a causal effect.</p>
</div>
</div>
</div>
<p>Assuming we meet the assumptions, there are multiple estimators, including regression, matching, propensity score matching, and weighting.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Regression</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Matching</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Propensity Scores</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false">Weighting</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Regression is the most popular estimator for selection on observables. There are two types of regression estimators.</p>
<p><strong>Classical linear regression</strong> with OLS and robust standard errors is used to estimate the ATE when we believe we have <u>constant treatment effects</u> for all units (where each unit <span class="math inline">\(t\)</span> has the same <span class="math inline">\(\tau\)</span> effect):</p>
<p><span class="math display">\[
\textcolor{purple}{Y_t^{(d)}} = \alpha + D_t\tau + \b x_t \b\gamma + \eps_t
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> fixest<span class="sc">::</span><span class="fu">feols</span>(Y <span class="sc">~</span> D <span class="sc">+</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> mydata, <span class="at">se =</span> <span class="st">"hetero"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, classical linear regression is <strong>biased</strong> for the ATE if we have heterogenous treatment effects (different units have different <span class="math inline">\(\tau\)</span>). It actually is an unbiased estimator for a weighted average of the ATT and ATU, not the ATE.</p>
<p>Instead, with heterogeneity, we should use the <strong>Fully Interacted Estimator</strong>:</p>
<p><span class="math display">\[
\textcolor{purple}{Y_t^{(d)}} = \alpha + D_t \tau + (\b x_t - \bar{\b x})\b\beta + D_t(\b x_t - \bar{\b x})\b\gamma + \eps_t
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_lin</span>(Y <span class="sc">~</span> D, <span class="at">covariates =</span> <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> my_data)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The fully interacted estimator is slightly biased when estimating <span class="math inline">\(\tau_{ATE}\)</span>, but the bias is arbitrarily small in large sample sizes. When we have a good amount of data, we tend to default to this estimator.</p>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Matching estimates missing potential outcomes/counterfactuals for each observation in the treated group, by matching an untreated observation to that treated observation. The matching process is done by similarity on covariates <span class="math inline">\(\set X\)</span>. Matching estimates the ATT:</p>
<p><span class="math display">\[
\hat\tau_{ATT} = \frac{1}{N_1} \sum\limits_{t:D_i = 1}^{N_1}(Y_t - \tilde Y_t)
\]</span></p>
<p>Where <span class="math inline">\(N_1\)</span> is the number of observations of units in the treatment group, <span class="math inline">\(Y_i\)</span> is the observed <span class="math inline">\(Y\)</span> of unit <span class="math inline">\(t\)</span> in the treated group, and <span class="math inline">\(\tilde Y_i\)</span> is the observed <span class="math inline">\(Y\)</span> value of the control unit matched to unit <span class="math inline">\(t\)</span>. Matching takes an average difference of the matched pairs.</p>
<p>We can also match multiple control units <span class="math inline">\(\tilde Y_t\)</span> to one treated unit <span class="math inline">\(t\)</span>, and average the value of those control units to create a closer match with the treated unit <span class="math inline">\(t\)</span>.</p>
<p>To determine what units are “closest” to each other in similarity of covariates <span class="math inline">\(\set X\)</span> for matching, the typical choice is mahalanobis distance, which calculates the distance between a unit <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>:</p>
<p><span class="math display">\[
D_M(i,j) = \sqrt{(\b x_i - \b x_j)^\top \b\Sigma_x^{-1}(\b x_i - \b x_j)}
\]</span></p>
<p>Where <span class="math inline">\(\b\Sigma_x\)</span> is the covariance matrix of confounders <span class="math inline">\(\set X\)</span>. The units in treatment and control that have the smallest distances are matched. Matching is done in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#matching units</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>match_obj <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3, <span class="at">data =</span> my_data,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>match_data <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">match.data</span>(match_obj, <span class="at">weights =</span> <span class="st">"nn_weights"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#estimate</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>att <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(Y <span class="sc">~</span> D, <span class="at">data =</span> match_data, <span class="at">weights =</span> nn_weights)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(att)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The matching estimator is prone to bias/poor-matches as the number of covariates you have increases. Generally, with many covaraites, propensity scores are more popular.</p>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>Propensity score matching is similar to matching, and also estimates the ATT.</p>
<p>However, instead of matching on covariates, it matches on the likelihood of a unit <span class="math inline">\(t\)</span> receiving treatment <span class="math inline">\(D_t = 1\)</span>, based on their covariate <span class="math inline">\(\set X_t\)</span> values. This likelihood/probability is called the propensity score.</p>
<p><span class="math display">\[
\pr_t(\set X_t) = \P(D_t = 1 | \set X_t)
\]</span></p>
<p>However, we do not actually observe <span class="math inline">\(\pr_t(\set X_t)\)</span>. We can estimate <span class="math inline">\(\pr_t(\set X_t)\)</span> with a binary response model with outcome <span class="math inline">\(D_t\)</span>, and explanatory variables <span class="math inline">\(\set X\)</span>. Then using the fitted probabilities <span class="math inline">\(\P(D_t = 1) = \hat\pr_t(\set X_t)\)</span>, we can conduct matching based on these estimates.</p>
<p>To implement propensity score matching in R, we start with our binary response variable. The most common choice is logistic regression, but random forest is also possible:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># logistic model</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> my_data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rf model</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">data =</span> my_data,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.action =</span> na.omit)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate propensity scores</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we conduct matching with the estimated propensity scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#matching units</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>match_obj <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">matchit</span>(D <span class="sc">~</span> ps, <span class="at">data =</span> my_data,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>match_data <span class="ot">&lt;-</span> MatchIt<span class="sc">::</span><span class="fu">match.data</span>(match_obj, <span class="at">weights =</span> <span class="st">"pscore_weights"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#estimate</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>att <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(Y <span class="sc">~</span> D, <span class="at">data =</span> match_data,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">weights =</span> pscore_weights)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(att)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<p>Matching only recovers the ATT. However, if we want the ATE, we can use propensity scores in a inverse probability weighting (IPW) estimator. It can be shown with math that the ATE with propensity scores <span class="math inline">\(\pr_t(\set X_t)\)</span> can be identified as:</p>
<p><span class="math display">\[
\tau_{ATE} = \E\left[ Y_t \cdot \frac{D_t - \pr_t(\set X_t)}{\pr_t(\set X_t)(1-\pr_t(\set X_t))} \right]
\]</span></p>
<p>We can use our sample equivalents to estimate the ATE:</p>
<p><span class="math display">\[
\begin{align}
\hat\tau_{ATE} &amp; = \frac{1}{N}\sum\limits_{i=1}^N\left(Y_t \cdot \frac{D_t - \hat\pr_t(\set X_t)}{\hat\pr_t(\set X_t)(1-\hat\pr_t(\set X_t))} \right) \\
&amp; = \frac{1}{N} \sum\limits_{i=1}^N\left( Y_tD_t\frac{1}{\hat\pr_t(\set X_t)} - Y_t(1-D_t)\frac{1}{1 - \hat\pr_t(\set X_t)}\right)
\end{align}
\]</span></p>
<p>We see that units who are unlikely to recieve treatment (low propensity scores) that actually get treated get weighted more, and units who are likely to be treated (high propensity scores) but don’t get treated also get weighted more.</p>
<p>We first estimate the propensity scores with either logistic or random forest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># logistic model</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> <span class="fu">glm</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2, <span class="at">data =</span> my_data, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rf model</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ps_model <span class="ot">&lt;-</span> randomForest<span class="sc">::</span><span class="fu">randomForest</span>(D <span class="sc">~</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">data =</span> my_data,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.action =</span> na.omit)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate propensity scores</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>ps <span class="ot">&lt;-</span> <span class="fu">predict</span>(ps_model, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we calculate the weights and estimate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>my_data<span class="sc">$</span>ipw <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(mydata<span class="sc">$</span>D <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span>my_data<span class="sc">$</span>ps, <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>my_data<span class="sc">$</span>ps))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ate <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(Y<span class="sc">~</span>D, <span class="at">data =</span> my_data, <span class="at">weights =</span> ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The IPW estimator is asymptotically consistent, but has poor small sample properties, and are sensitive to extreme values of <span class="math inline">\(\hat\pr_t(\set X_t)\)</span>.</p>
</div>
</div>
</div>
<p>We should generally be careful with selection on observables, as it is considered to be the least robust of the quasi-experimental designs. This is particularly the case in the social sciences, when there are tons and tons of unobservable confounders which are nearly impossible to control for.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./nonlinear.html" class="pagination-link" aria-label="Non-Linear Methods">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-Linear Methods</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./time.html" class="pagination-link" aria-label="Time Series Methods">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>