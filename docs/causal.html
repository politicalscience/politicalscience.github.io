<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Theoretical Causal Inference – Kevin's PSPE Resources</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<link href="./thecauses.html" rel="next">
<link href="./ols.html" rel="prev">
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="mathjax-config.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./random.html">Theoretical Statistics</a></li><li class="breadcrumb-item"><a href="./causal.html"><span class="chapter-title">Theoretical Causal Inference</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Kevin’s PSPE Resources</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Theoretical Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Random Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Statistical Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mle.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Maximum Likelihood</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ols.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Least Squares Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./causal.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Theoretical Causal Inference</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Applied Statistics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thecauses.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Applied Causal Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stats.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Applied Statistical Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Game Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./games.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Guide to Game Theory</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Mathematics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./linear.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Linear Algebra</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calc.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Calculus and Probability</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Changing Soon</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glm.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Generalised Linear Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./identify.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Quasi-Experimental Methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multivariate.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Multivariate Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#potential-outcomes-framework" id="toc-potential-outcomes-framework" class="nav-link active" data-scroll-target="#potential-outcomes-framework">Potential Outcomes Framework</a></li>
  <li><a href="#structural-causal-models" id="toc-structural-causal-models" class="nav-link" data-scroll-target="#structural-causal-models">Structural Causal Models</a></li>
  <li><a href="#selection-bias" id="toc-selection-bias" class="nav-link" data-scroll-target="#selection-bias">Selection Bias</a></li>
  <li><a href="#confounders" id="toc-confounders" class="nav-link" data-scroll-target="#confounders">Confounders</a></li>
  <li><a href="#randomisation" id="toc-randomisation" class="nav-link" data-scroll-target="#randomisation">Randomisation</a></li>
  <li><a href="#selection-on-observables" id="toc-selection-on-observables" class="nav-link" data-scroll-target="#selection-on-observables">Selection on Observables</a></li>
  <li><a href="#instrumental-variables" id="toc-instrumental-variables" class="nav-link" data-scroll-target="#instrumental-variables">Instrumental Variables</a></li>
  <li><a href="#regression-discontinuity" id="toc-regression-discontinuity" class="nav-link" data-scroll-target="#regression-discontinuity">Regression Discontinuity</a></li>
  <li><a href="#differences-in-differences" id="toc-differences-in-differences" class="nav-link" data-scroll-target="#differences-in-differences">Differences-in-Differences</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./random.html">Theoretical Statistics</a></li><li class="breadcrumb-item"><a href="./causal.html"><span class="chapter-title">Theoretical Causal Inference</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">Theoretical Causal Inference</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>So far, we have introduced multiple estimators to help estimate parameters that describe the relationships between variables.</p>
<p>In this chapter, our goal is to go from relationships/correlation to causation. First, we introduce the popular causal frameworks and causal estimands. Then, we discuss the issue with selection bias, and why correlation is not causation. Finally, we discuss ways to identify the treatment effects and overcome selection bias.</p>
<p><br></p>
<section id="potential-outcomes-framework" class="level2">
<h2 class="anchored" data-anchor-id="potential-outcomes-framework">Potential Outcomes Framework</h2>
<p>A lot of social science and science is about understanding the causes of things. This involves understanding how some treatment variable <span class="math inline">\(D\)</span> causes some outcome variable <span class="math inline">\(Y\)</span>. We call our treatment variable <span class="math inline">\(D\)</span>. For each unit <span class="math inline">\(t\)</span>, they have a treatment status of <span class="math inline">\(D_t\)</span>:</p>
<p><span class="math display">\[
D_t = \begin{cases}
1 &amp; \text{if unit t received the treatment} \\
0 &amp; \text{if unit t did not receive the treatment}
\end{cases}
\]</span></p>
<p>Now, imagine that there are two parallel worlds. In one of these parallel worlds, unit <span class="math inline">\(t\)</span> receives the treatment <span class="math inline">\(D_t = 1\)</span>. In the other parallel world, unit <span class="math inline">\(t\)</span> does not receive the treatment <span class="math inline">\(D_t = 0\)</span>. Everything about these two parallel worlds besides <span class="math inline">\(D_i\)</span> is identical. The outcome <span class="math inline">\(Y\)</span> value in these two worlds is called the potential outcomes.</p>
<div id="def-potoutcomes" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.1 (Potential Outcomes)</strong></span> The potential outcomes <span class="math inline">\(Y_t(d)\)</span> for unit <span class="math inline">\(t\)</span> are the <span class="math inline">\(Y\)</span> values in the two identical parallel worlds besides the <span class="math inline">\(D_t\)</span> value.</p>
<p><span class="math display">\[
Y_t^{(d)} = \begin{cases}
\pt &amp; D_t = 1\text{ parallel world outcome Y value for unit t} \\
\pc &amp; D_t = 0\text{ parallel world outcome Y value for unit t} \\
\end{cases}
\]</span></p>
<p>To make clear when talking about potential outcomes, I will always highlight them in purple.</p>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stable Unit Treatment Value Assumption
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The above mentioned potential outcomes framework depends on the stablue unit treatment value assumption (SUTVA).</p>
<p>It basically says that unit <span class="math inline">\(t\)</span>’s potential outcomes <span class="math inline">\(Y_t(1)\)</span> and <span class="math inline">\(Y_{t}(0)\)</span> are not affected in any way by another unit <span class="math inline">\(j\)</span>’s treatment status <span class="math inline">\(D_j\)</span>. Basically, changing other individual’s treatment status has no effect on an individual’s own outcomes.</p>
<p>If SUTVA is violated, then our nice two parallel worlds example no longer is accurate. This is because if SUTVA is violated, unit <span class="math inline">\(t\)</span> now has the potential outcomes of themselves receiving <span class="math inline">\(D_t = 1, 0\)</span>, but also other people <span class="math inline">\(D_j = 0, 1\)</span>. This will make the number of outcomes grow massively (especially if multiply other units affect an individual).</p>
<p>Common causes of SUTVA violations include:</p>
<ul>
<li>Spill-over effects: If we are testing a new curriculum, one student <span class="math inline">\(j\)</span> getting the new curriculum may teach their friend <span class="math inline">\(t\)</span> the new curriculum, which means if student <span class="math inline">\(j\)</span> got or did not get the new curriculum would affect student <span class="math inline">\(t\)</span>’s outcomes.</li>
<li>Dilution: For example, in vaccines, there is herd immunity. That means other people getting the vaccines also improves my health outcomes.</li>
</ul>
</div>
</div>
</div>
<p>If we know the two hypothetical parallel worlds are identical to each other <u>except</u> for treatment <span class="math inline">\(D_t\)</span>, then we know any difference in <span class="math inline">\(Y\)</span> outcomes between the two worlds must be a result of treatment <span class="math inline">\(D\)</span>. This introduces us to the causal estimands - the true causal effects in the population:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">ITE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">ATE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">ATT</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">ATU</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">CATE</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="def-ite" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5.2 (Individual Treatment Effect)</strong></span> The individual treatment effect of treatment <span class="math inline">\(D\)</span> on <span class="math inline">\(Y\)</span>, for a specific unit <span class="math inline">\(i\)</span>, is given by the difference between the potential outcomes.</p>
<p><span class="math display">\[
\tau_t = \pt - \pc
\]</span></p>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div id="def-ate" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5.3 (Average Treatment Effect)</strong></span> The ATE is the average individual treatment effects <span class="math inline">\(\tau_i\)</span> in the population.</p>
<p><span class="math display">\[
\tau_{ATE} = \E(\tau_t) \  = \  \E(\pt - \pc)  \ = \  \E \pt - \E \pc
\]</span></p>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div id="def-att" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5.4 (Average Treatment Effect on the Treated)</strong></span> The ATT is the average individual treatment effect <span class="math inline">\(\tau_i\)</span> for only units that were assigned to the treatment group <span class="math inline">\(D_i = 1\)</span>:</p>
<p><span class="math display">\[
\tau_{ATT} = \E(\tau_t | D_t = 1) \ = \ \E(\pt - \pc | D_t = 1)
\]</span></p>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div id="def-atu" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5.5 (Average Treatment Effect on the Untreated)</strong></span> The ATU is the average individual treatment effect <span class="math inline">\(\tau_i\)</span> for only units that were assigned to the control group <span class="math inline">\(D_i = 0\)</span>:</p>
<p><span class="math display">\[
\tau_{ATT} = \E(\tau_t | D_t = 0) \ = \ \E(\pt - \pc | D_t = 0)
\]</span></p>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div id="def-cate" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 5.6 (Conditional Average Treatment Effect)</strong></span> The CATE is the average treatment effect, conditional on some other characteristic/covariate <span class="math inline">\(X\)</span> value:</p>
<p><span class="math display">\[
\tau_{CATE}(x) = \E(\tau_t| X = x) \ = \ \E(\pt - \pc|X=x)
\]</span></p>
<p>This estimand is also sometimes called the local average treatment effect (LATE).</p>
</div>
</div>
</div>
</div>
<p>However, there is an issue: in the real world, we obviously do not have two hypothetical parallel worlds. We only have one world - either unit <span class="math inline">\(t\)</span> gets treated <span class="math inline">\(D_t = 1\)</span> or unit <span class="math inline">\(t\)</span> does not get treated <span class="math inline">\(D_t = 0\)</span>. The world we actually live in is called the observed outcome, and the parallel world we do not see is called the counterfactual. The fact we cannot observe the counterfactual is called the <strong>fundamental problem of causal inference</strong>.</p>
<div id="def-observedoutcomes" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.7 (Observed Outcomes and Counterfactuals)</strong></span> The observed outcome <span class="math inline">\(Y_t\)</span> that we actually see for a unit <span class="math inline">\(t\)</span> can be given by a function of potential outcomes:</p>
<p><span class="math display">\[
Y_t = D_t \cdot \pt + (1-D_i) \cdot \pc
\]</span></p>
<p>If we plug in the treatment status <span class="math inline">\(D_t = 0, 1\)</span> of unit <span class="math inline">\(t\)</span> into the above equation, we get observed outcomes</p>
<p><span class="math display">\[
Y_t = \begin{cases}
\pt &amp; \text{if} D_i = 1 \\
\pc &amp; \text{if} D_i = 0
\end{cases}
\]</span></p>
<p>The potential outcome that is not observed is the counterfactual outcome.</p>
</div>
<p><br></p>
</section>
<section id="structural-causal-models" class="level2">
<h2 class="anchored" data-anchor-id="structural-causal-models">Structural Causal Models</h2>
<p>An alternative causal framework, pioneered by Pearl, is called the structural causal models. This framework uses graphical models (called directed acyclic graphs) to illustrate causality.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3021970542.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:30.0%"></p>
</figure>
</div>
<p>Every causal graph illustrates how different variables are connected to each other. Each graph contains:</p>
<ol type="1">
<li>Nodes: These are letters that represent different variables.</li>
<li>Directed Edges: these are arrows that encode causal theories between the variables. For example, if you believe <span class="math inline">\(Z\)</span> causes <span class="math inline">\(D\)</span>, you would draw an arrow <span class="math inline">\(Z \rightarrow D\)</span>. These connections are either observable (solid lines) or unobservable (dashed lines).</li>
</ol>
<p><strong>Paths</strong> are any route between any two variables, that do not have to follow the direction of the arrows. For example, in the figure above, between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span>, there are 3 paths:</p>
<ol type="1">
<li>The direct path <span class="math inline">\(D \rightarrow Y\)</span>.</li>
<li>The inderect/backdoor path <span class="math inline">\(D \leftarrow Q \rightarrow Y\)</span>.</li>
<li>The indirect/backdoor path <span class="math inline">\(D \leftarrow Z \leftarrow W \rightarrow Y\)</span>.</li>
</ol>
<p>The goal in causal inference is to get rid of all the indirect/backdoor paths, allowing us to isolate the direct relationship between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span>. There are two ways to isolate the direct relationship: external intervention and blocking paths.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">External Intervention</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Blocking Paths</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>One way to isolate a causal path is through an <strong>external intervention</strong>. For example, in the figure below, variable <span class="math inline">\(D\)</span> is directly caused by <span class="math inline">\(Q\)</span> and <span class="math inline">\(Z\)</span>. This allows indirect paths between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span> to flow between <span class="math inline">\(Q\)</span> and <span class="math inline">\(Z\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3951308334.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:30.0%"></p>
</figure>
</div>
<p>However, by externally determining <span class="math inline">\(D\)</span> (represented with the operator <span class="math inline">\(d_0\)</span>), we can break the paths <span class="math inline">\(Q \rightarrow D\)</span> and <span class="math inline">\(Z \rightarrow D\)</span>. This is because if we are deciding who gets <span class="math inline">\(D\)</span> (such as by randomisation), that means we are deciding <span class="math inline">\(D\)</span>, not <span class="math inline">\(Q\)</span> or <span class="math inline">\(Z\)</span>. This will allow us to block backdoor paths, and our new diagram will be:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2834742175.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:30.0%"></p>
</figure>
</div>
<p>And thus, we have isolated the causal relationship.</p>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>On the other hand, we can block indirect/backdoor paths through conditioning on a set of variables/nodes <span class="math inline">\(\set X\)</span>. A set of nodes <span class="math inline">\(\cal X\)</span> blocks a path if one of two is true:</p>
<ol type="1">
<li>A path is blocked if our set of conditioning nodes <span class="math inline">\(\set X\)</span> includes at least one arrow-emitting node within that path.</li>
<li>A path is blocked if the path contains a collision node (where multiple arrows point into it), and that collision node is not included in our set of conditioning nodes <span class="math inline">\(\set X\)</span>.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3519172210.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:40.0%"></p>
</figure>
</div>
<p>For example, in the figure above, we can see:</p>
<ol type="1">
<li>The path <span class="math inline">\(D \rightarrow P \rightarrow Y\)</span> is blocked by a set <span class="math inline">\(\set X = \{P\}\)</span>, since <span class="math inline">\(P\)</span> is one arrow emitting node within this path.</li>
<li>The path <span class="math inline">\(D \leftarrow M \rightarrow Y\)</span> is blocked by a set <span class="math inline">\(\set X = \{M\}\)</span>, because <span class="math inline">\(M\)</span> is one arrow emitting node within this path.</li>
<li>The path <span class="math inline">\(D \leftarrow Z \rightarrow M \rightarrow Y\)</span> is blocked by either <span class="math inline">\(\set X = \{M\}, \{Z\}\)</span> or <span class="math inline">\(\{M, Z\}\)</span>.</li>
<li>The path <span class="math inline">\(D \leftarrow Z \rightarrow M \leftarrow Q \rightarrow Y\)</span> is blocked by an empty set <span class="math inline">\(\set X = \varnothing\)</span>, because <span class="math inline">\(M\)</span> is a collider node in this path and we do not need to include it.</li>
</ol>
<p>We will discuss the idea of blocking paths more in the next chapter.</p>
</div>
</div>
</div>
<p><br></p>
</section>
<section id="selection-bias" class="level2">
<h2 class="anchored" data-anchor-id="selection-bias">Selection Bias</h2>
<p>You always here the saying - correlation is not causation. But what does that actually mean? A simple model of correlation <span class="math inline">\(\rho\)</span> is finding how observed <span class="math inline">\(Y\)</span> changes when <span class="math inline">\(D\)</span> changes. More specifically, we want to find the differences in conditional expectations (given by <a href="random.html#def-condexp" class="quarto-xref">definition&nbsp;<span>1.8</span></a>) of observed <span class="math inline">\(Y_t\)</span> values for when <span class="math inline">\(D_t = 1\)</span> and <span class="math inline">\(D_t = 0\)</span>:</p>
<p><span class="math display">\[
\rho_{D, Y} = \E(Y_t|D_t = 1) - \E (Y_t | D_t = 0)
\]</span>Now, let us do some algebra. First, we know that <span class="math inline">\(Y_t|D_t = 1\)</span> is the observed potential outcome <span class="math inline">\(\pt\)</span>. We also know that <span class="math inline">\(Y_t|D_t = 0\)</span> is the observed potential outcome <span class="math inline">\(\pc\)</span>. Thus, we can rewrite the above to</p>
<p><span class="math display">\[
\rho_{D, Y} = \E(\pt|D_i = 1) - \E(\pc|D_i = 0)
\]</span></p>
<p>Now, let us do an algebra trick. We know that adding a zero doesn’t change the equality of the equation. Let us add the term <span class="math inline">\(\E(\pc|D_t = 1)\)</span>, but then also subtract that term, so we are essentially adding a 0. Then we get</p>
<p><span class="math display">\[
\begin{align}
\rho_{D, Y} = \E(\pt &amp;|D_t = 1) - \E(\pc|D_t = 0) \\
&amp; + \E(\pc|D_t = 1) - \E(\pc|D_t = 1)
\end{align}
\]</span></p>
<p>Let us rearrange the order of the terms to get</p>
<p><span id="eq-selectionbias"><span class="math display">\[
\begin{align}
\rho_{D, Y} &amp; = \overbrace{\E(\pt|D_t = 1) - \E(\pc|D_t = 1)}^{\tau_{ATT}} \\
&amp; \qquad \qquad \qquad \underbrace{+ \E(\pc|D_t = 1) - \E(\pc|D_t = 0)}_{\text{selection bias}}
\end{align}
\tag{5.1}\]</span></span></p>
<p>We can see that according to <a href="#def-att" class="quarto-xref">definition&nbsp;<span>5.4</span></a>, the first part of this correlation between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span> is the ATT, one of the causal estimands. However, the correlation <span class="math inline">\(\rho_{D,Y}\)</span> does not only equal the <span class="math inline">\(\tau_{ATT}\)</span>, as there is an extra bit, the <em>selection bias</em>. If this selection bias is not 0, then our correlation is clearly not equal to our ATT.</p>
<p>Let us look at the selection bias term more carefully:</p>
<p><span class="math display">\[
\underbrace{+ \E(\pc|D_t = 1) - \E(\pc|D_t = 0)}_{\text{selection bias}}
\]</span></p>
<p>The first part is the average potential outcome under parallel world <span class="math inline">\(D_t = 0\)</span> for the units that were assigned to treatment <span class="math inline">\(D_t = 1\)</span>. The second part is the average potential outcome under parallel world <span class="math inline">\(D_t = 0\)</span> for units that were assigned to control <span class="math inline">\(D_t = 0\)</span>.</p>
<p>If this term is non-zero, that means the control group and treatment group have different average <span class="math inline">\(\pc\)</span> values. That means, before our experiment had even started, the control and treatment groups had different baseline potential outcome <span class="math inline">\(\pc\)</span>. If for example, the treatment group <span class="math inline">\(D_t = 1\)</span> initially had a very low <span class="math inline">\(\pc\)</span>, even after treatment with true effect <span class="math inline">\(+\tau\)</span>, their outcome <span class="math inline">\(Y_t\)</span> may still be lower than people who didn’t get the treatment. So, our correlation <span class="math inline">\(\rho_{D,Y}\)</span> would pick up a negative treatment effect, when the actual treatment effect is positive <span class="math inline">\(+\tau\)</span>.</p>
<p>A good intuitive example is the question: <em>does going to the hospital improve your life expectancy</em>? If we were to just collect correlation data, we would see that actually, people who went to the hospital have lower life expectancy.</p>
<p>But, that is because people who go to the hospital in the first place already have low life expectancy <span class="math inline">\(\pc\)</span> compared to people who didn’t go. The hospital will cause these people with low life expectancy to have longer lives (treatment effect <span class="math inline">\(\tau\)</span>), but even with <span class="math inline">\(\pc + \tau\)</span>, their life expectancy may still be lower than the <span class="math inline">\(\pc\)</span> of the group who never went to the hospital.</p>
<p>Thus, our correlation measure shows a negative effect of going to the hospital on life expectancy, when in reality, going to the hospital does boost life expectancy, its just people who choose to go to the hospital start off with lower life expectancy than those who do not go.</p>
<p><br></p>
</section>
<section id="confounders" class="level2">
<h2 class="anchored" data-anchor-id="confounders">Confounders</h2>
<p>The reason for this difference in pre-experiment <span class="math inline">\(\pc\)</span> is a third variable <span class="math inline">\(X\)</span> is causing people to go to select treatment <span class="math inline">\(D\)</span> more frequently, and also has some effect on <span class="math inline">\(Y\)</span>. <span class="math inline">\(X\)</span> is thus causing <strong>selection bias</strong>. An <span class="math inline">\(X\)</span> that causes selection bias is called a confounder.</p>
<div id="def-confounder" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.8 (Confounder)</strong></span> A confounder is a third variable <span class="math inline">\(X\)</span> that causes selection into treatment <span class="math inline">\(D\)</span> and causes changes in outcome <span class="math inline">\(Y\)</span>. If there is such a variable, this creates selection bias, and makes correlation not equal causation.</p>
</div>
<p><br></p>
<p>For example, there is a well known correlation in the real world that <em>ice cream sales</em> are strongly correlated with <em>shark attacks</em>. So does <em>ice cream sales</em> actually cause more <em>shark attacks</em>?</p>
<p>The answer is (likely) no. The reason we see this correlation is because of a third variable - the <em>weather</em>. When the <em>weather</em> is warm, more people buy ice cream, and more people go to the ocean, hence increasing the amount of shark attacks.</p>
<p><em>Weather</em> is a third variable that we consider a confounder, as it affects both <em>ice cream sales</em> and <em>shark attacks</em>. There is actually no relationship between <em>ice cream sales</em> and <em>shark attacks</em> - the perceived correlation is caused by the confounder <em>weather</em>.</p>
<p>Our goal in causal inference is to eliminate the effects of the confounders and isolate the effects between treatment and outcome. We can also visualise confounders in a structural causal model:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-2044932443.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:35.0%"></p>
</figure>
</div>
<p>For example, the figure above, <span class="math inline">\(X\)</span> is confounding the relationship between <span class="math inline">\(D \rightarrow Y\)</span>. This is because both <span class="math inline">\(X\)</span> is correlated with <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span>. When we naively estimated the correlation <span class="math inline">\(\rho_{D,Y}\)</span>, we are estimating the relationship between <span class="math inline">\(D \rightarrow Y\)</span> <u>and</u> the relationship <span class="math inline">\(D \leftarrow X \rightarrow Y\)</span> . But, the true causal effect is <span class="math inline">\(D \rightarrow Y\)</span>, without the other backdoor path. For accurate causal estimation, we need some way to “block” the path through <span class="math inline">\(X\)</span>.</p>
<p>Why isn’t <span class="math inline">\(V\)</span> a confounder? Well, <span class="math inline">\(V\)</span> does not cause selection into <span class="math inline">\(D\)</span>, as the arrow direction shows that <span class="math inline">\(D\)</span> causes <span class="math inline">\(V\)</span>. Thus, <span class="math inline">\(V\)</span> is not causing selection bias. We do not care about variables caused by <span class="math inline">\(D\)</span>.</p>
<p><br></p>
</section>
<section id="randomisation" class="level2">
<h2 class="anchored" data-anchor-id="randomisation">Randomisation</h2>
<p>One way we can eliminate selection bias is through randomly assigning our subjects to either treatment <span class="math inline">\(D_t = 1\)</span> or control <span class="math inline">\(D_t = 0\)</span>. Randomisation implies that the assignment probabilities do not depend on the potential outcomes - the values of <span class="math inline">\(\pc\)</span> and <span class="math inline">\(\pt\)</span> do not affect the probability of a unit <span class="math inline">\(t\)</span> getting put into treatment <span class="math inline">\(D_t = 1\)</span> or control <span class="math inline">\(D_t = 0\)</span>.</p>
<p><span class="math display">\[
\P(D_t = 1 | \pc) = \P(D_t = 1 | \pt)  =  \P(D_t = 1)
\]</span></p>
<p>This fact implies the critical assumption of randomisation, independence.</p>
<div id="def-randomisation" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.9 (Independence)</strong></span> Randomisation, if done properly, implies independence. Independence, also called unconfoundedness or ignorability, is the statement that potential outcomes are independent of treatment:</p>
<p><span class="math display">\[
\pc, \pt \ind D_t
\]</span></p>
<p>This assumption, and the defintition of independence from <a href="random.html#def-independence" class="quarto-xref">definition&nbsp;<span>1.6</span></a>, implies that <span class="math inline">\(\E Y_{t}(0)\)</span> and <span class="math inline">\(\E Y_{t}(1)\)</span> are equal between treatment and control:</p>
<p><span class="math display">\[
\begin{align}
&amp; \E(\pc|D_t = 1) \ = \ \E(\pc|D_t = 0) \ = \ \E \pc \\
&amp; \E(\pt|D_t = 1) \ = \ \E(\pt|D_t = 0) \ = \ \E \pt
\end{align}
\]</span></p>
</div>
<p>We can prove that randomisation and the independence assumption allow us to eliminate the selection bias shown in <a href="#eq-selectionbias" class="quarto-xref">eq.&nbsp;<span>5.1</span></a>. Let us start with our correlation from <a href="#eq-selectionbias" class="quarto-xref">eq.&nbsp;<span>5.1</span></a>:</p>
<p><span class="math display">\[
\begin{align}
\rho_{D, Y} &amp; = \overbrace{\E(\pt|D_t = 1)- \E(\pc|D_t = 1)}^{\tau_{ATT}} \\
&amp; \qquad \qquad \qquad + \underbrace{\E(\pc|D_t = 1) - \E(\pc|D_t = 0)}_{\text{selection bias}}
\end{align}
\]</span></p>
<p>Using the properties of independence from <a href="#def-randomisation" class="quarto-xref">definition&nbsp;<span>5.9</span></a>, we can get</p>
<p><span class="math display">\[
\begin{align}
\rho_{D, Y} &amp; = \underbrace{\E(\pt|D_t = 1)- \E(\pc|D_t = 1)}_{\tau_{ATT}} + \underbrace{\E \pc - \E \pc}_{\text{selection bias}} \\
&amp; = \underbrace{\E(\pt|D_t = 1)- \E(\pc|D_i = 1)}_{\tau_{ATT}} + 0
\end{align}
\]</span></p>
<p>Thus, we can see the assumption of independence has removed our selection bias, and allowed us to accurately calculate our <span class="math inline">\(\tau_{ATT}\)</span> simply by looking at the correlation <span class="math inline">\(\rho_{D,Y}\)</span>.</p>
<p>We can also identify the ATE from our correlation <span class="math inline">\(\rho_{D,Y}\)</span>, by simplifying once again using the properties implied by the assumption of independence from <a href="#def-randomisation" class="quarto-xref">definition&nbsp;<span>5.9</span></a>:</p>
<p><span class="math display">\[
\begin{align}
\rho_{D, Y} &amp; = \underbrace{\E(\pt|D_i = 1)- \E(\pc|D_i = 1)}_{\tau_{ATT}} \\
&amp; = \underbrace{\E \pt - \E \pc}_{\tau_{ATE}}
\end{align}
\]</span></p>
<p>Which according to <a href="#def-ate" class="quarto-xref">definition&nbsp;<span>5.3</span></a>, is the ATE. Thus, under randomisation, our correlation measure <span class="math inline">\(\rho_{D, Y} = \tau_{ATT} = \tau_{ATE}\)</span>. Recall our correlation measure again <span class="math inline">\(\rho_{D, Y}\)</span> was simply a comparison of observed outcomes between treatment and control groups:</p>
<p><span class="math display">\[
\rho_{D, Y} = \E(Y_t|D_t = 1) - \E (Y_t | D_t = 0) = \tau_{ATE} = \tau_{ATT}
\]</span></p>
<p>Since <span class="math inline">\(\rho_{D, Y}\)</span> only requires observed outcomes (not potential), we can calculate <span class="math inline">\(\rho_{D, Y}\)</span>, which is also equal to the ATE and ATT under randomisation. Thus, we have identified a way to find the ATE and ATT with just observed outcomes. This means that under randomisation, simple correlation models also give us causal effects.</p>
<p><br></p>
</section>
<section id="selection-on-observables" class="level2">
<h2 class="anchored" data-anchor-id="selection-on-observables">Selection on Observables</h2>
<p>Selection on Observables is an way to get rid of the selection bias problem by <a href="./causal.html#confounders">controlling for a set of confounders</a> <span class="math inline">\(\mathcal X\)</span> to <a href="./causal.html#structural-causal-models">block backdoor paths</a> and isolate the relationship between <span class="math inline">\(D \rightarrow Y\)</span>.</p>
<p>There are two assumptions for selection on observables:</p>
<div id="def-sooassumptions" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.10 (Selection on Observables)</strong></span> <strong>Conditional Ignorability</strong> (also called conditional independence) means that among units <span class="math inline">\(i\)</span> with identical confounder values <span class="math inline">\(\mathcal X_i\)</span>, treatment <span class="math inline">\(D_i\)</span> is as-if randomly assigned. Potential outcomes are independent from treatment within each specific confounder value <span class="math inline">\(\mathcal X_i = x\)</span>.</p>
<p><span class="math display">\[
(\pc, \pt) \ind D_t \ | \ \set X_t = x, \ \forall \ x \in \set X
\]</span></p>
<p>This assumption implies that given any value of confounders <span class="math inline">\(\set X_t = x\)</span>, potential outcomes are equivalent between treatment and control groups:</p>
<p><span class="math display">\[
\begin{align}
&amp; \E(\pc|D_t = 1, \set X_t = x) \ = \ \E(\pc|D_t = 0, \set X_t = x) \ = \ \E(\pc|\set X_t = x) \\
&amp; \E(\pt|D_t = 1, \set X_t = x) \ = \ \E(\pt|D_t = 0, \set X_t = x) \ = \ \E(\pt|\set X_t = x)
\end{align}
\]</span></p>
<p><strong>Common Support</strong> is the second assumption, and it states for any unit <span class="math inline">\(t\)</span> with any value of <span class="math inline">\(\mathcal X_t\)</span>, they have a non-zero probability they can be assigned to both control and treatment.</p>
</div>
<p>If these two assumptions are met, we can identify the ATE and ATT. The proofs are provided below:</p>
<div class="tabset-margin-container"></div><div class="panel-tabset nav-pills">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Identification of ATE</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Identification of ATT</a></li></ul>
<div class="tab-content nav-pills">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Using these assumptions, we can first identify the CATE, which will allow us to identify the ATE. Let us first start with the definition of CATE (<a href="#def-cate" class="quarto-xref">definition&nbsp;<span>5.6</span></a>):</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt - \pc \ | \ \set X_t = x) \\
&amp; = \E(\pt | \set X_t = x) - \E(\pc|\set X_t = x) \\
\end{align}
\]</span></p>
<p>Now, from the properties implied by conditional ignorability given in <a href="identify.html#eq-selectiononobservables" class="quarto-xref">eq.&nbsp;<span>12.1</span></a>, we get</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt|D_i = 1, \set X_t = x) - \E(\pc|D_i = 0, \set X_t = x) \\
&amp; = \E(Y_{t}|D_t = 1, \mathcal X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x) \\
\end{align}
\]</span></p>
<p>And the second step above is because <span class="math inline">\(\pt|D_i = 1\)</span> and <span class="math inline">\(\pc|D_i = 0\)</span> are observable outcomes (<a href="#def-observedoutcomes" class="quarto-xref">definition&nbsp;<span>5.7</span></a>). Thus, with independence, we can identify the CATE with just observed outcomes.</p>
<p>Let us consider the definition of the ATE, which is <span class="math inline">\(\E(\pt - \pc)\)</span>. From the definition of expectation given in <a href="random.html#def-exp" class="quarto-xref">definition&nbsp;<span>1.2</span></a>, we can rewrite the ATE as</p>
<p><span class="math display">\[
\tau_{ATE} = \int\tau_{CATE}(x) \P(\mathcal x) dy
\]</span></p>
<p>Which is a weighted average. We established above that we can identify the CATE. Thus, we can plug the CATE into the ATE to get our identified ATE:</p>
<p><span class="math display">\[
\tau_{ATE} = \int [\E(Y_{t}|D_t = 1, \set X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x)] \P(x) dy
\]</span></p>
<p>And all the values in this equation are observed outcomes <span class="math inline">\(Y_t\)</span>, meaning if we control for set of confounders <span class="math inline">\(\mathcal X\)</span>, our correlation becomes a causal effect.</p>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Using these assumptions, we can first identify the CATE, which will allow us to identify the ATT. Let us first start with the definition of CATE (<a href="#def-cate" class="quarto-xref">definition&nbsp;<span>5.6</span></a>):</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt - \pc \ | \ \set X_t = x) \\
&amp; = \E(\pt | \set X_t = x) - \E(\pc|\set X_t = x) \\
\end{align}
\]</span></p>
<p>Now, from the properties implied by conditional ignorability given in <a href="identify.html#eq-selectiononobservables" class="quarto-xref">eq.&nbsp;<span>12.1</span></a>, we get</p>
<p><span class="math display">\[
\begin{align}
\tau_{CATE}(x) &amp; = \E(\pt|D_i = 1, \set X_t = x) - \E(\pc|D_i = 0, \set X_t = x) \\
&amp; = \E(Y_{t}|D_t = 1, \mathcal X_t = x) - \E(Y_{t}|D_t = 0, \set X_t = x) \\
\end{align}
\]</span></p>
<p>And the second step above is because <span class="math inline">\(\pt|D_i = 1\)</span> and <span class="math inline">\(\pc|D_i = 0\)</span> are observable outcomes (<a href="#def-observedoutcomes" class="quarto-xref">definition&nbsp;<span>5.7</span></a>). Thus, with independence, we can identify the CATE with just observed outcomes.</p>
<p>Let us consider the definition of the ATT, which is <span class="math inline">\(\E(\pc = \pt | D_i = 1)\)</span>. From the definition expectation given in <a href="random.html#def-exp" class="quarto-xref">definition&nbsp;<span>1.2</span></a>, we can rewrite the ATT as</p>
<p><span class="math display">\[
\tau_{ATT} = \int \tau_{CATE}(x) \P(x|D_t = 1) dy
\]</span></p>
<p>Which is a weighted average. We established above that we can identify the CATE. Thus, we can plug CATE into the ATE to get our identified ATT:</p>
<p><span class="math display">\[
\tau_{ATT} = \int [\E(Y_{t}|D_t = 1, \set X_t = x) - \E(Y_{t}|D_t = 0, \mathcal X_t = x)] \P(x|D_t = 1) dy
\]</span></p>
<p>And all the values in this equation are observed outcomes <span class="math inline">\(Y_t\)</span>, meaning if we control for set of confounders <span class="math inline">\(\mathcal X\)</span>, our correlation becomes a causal effect.</p>
</div>
</div>
</div>
<p>This means that if we condition on the necessary covariates to meet the identification assumptions, we can derive the causal effect.</p>
<p><br></p>
</section>
<section id="instrumental-variables" class="level2">
<h2 class="anchored" data-anchor-id="instrumental-variables">Instrumental Variables</h2>
<p>Let us assume an <strong>encouragement</strong> <span class="math inline">\(Z_t \in \{0, 1\}\)</span>, which is our treatment assignment/encouragement. Then, we have the <strong>treatment</strong> variable <span class="math inline">\(D_t \in \{0,1\}\)</span>, which is someone who actually took the treatment or not. Given this framework, we can divide all units <span class="math inline">\(i\)</span> into 4 categories:</p>
<ol type="1">
<li>Compliers: People who comply with encouragement <span class="math inline">\(Z_i\)</span>. Their <span class="math inline">\(Z_i = D_i\)</span>.</li>
<li>Always-takers: People who no matter what encouragement <span class="math inline">\(Z_i\)</span> is, always take treatment.</li>
<li>Never-takers: People who no matter their encouragement <span class="math inline">\(Z_i\)</span> is, never take treatment.</li>
<li>Defiers: People who do the opposite of encouragement <span class="math inline">\(Z_i\)</span>, so always <span class="math inline">\(D_i ≠ Z_i\)</span>.</li>
</ol>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Principle Strata
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We can visually show what will happen with all 4 types of people in a table, called the principal strata:</p>
<table class="table-bordered caption-top table">
<tbody>
<tr class="odd">
<td></td>
<td><span class="math inline">\(Z_i = 1\)</span></td>
<td><span class="math inline">\(Z_i = 0\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(D_i = 1\)</span></td>
<td>Complier/Always-Taker</td>
<td>Defier/Always-Taker</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(D_i = 0\)</span></td>
<td>Defier/Never-Taker</td>
<td>Complier/Never-Taker</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The idea of the non-compliance designs is to use our encouragement/treatment assignment <span class="math inline">\(Z\)</span> as an <a href="./ols.html#instrumental-variables-estimator">instrument</a> for <span class="math inline">\(D\)</span> - actually taking the treatment. There are 4 assumptions to the non-compliance designs:</p>
<div id="def-ivnoncomplianceassumptions" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.11 (Instrumental Variables Assumptions)</strong></span> &nbsp;</p>
<ol type="1">
<li><strong>Relevance</strong>: <span class="math inline">\(Z\)</span> must be correlated to <span class="math inline">\(D\)</span>, i.e.&nbsp;<span class="math inline">\(Cov(Z,D)≠0\)</span>. Or in other words, compilers must exist, or else, encouragement <span class="math inline">\(Z\)</span> would not affect treatment <span class="math inline">\(D\)</span>.</li>
<li><strong>Ignorability/Exogneity</strong>: There is no backdoor path between <span class="math inline">\(Z\)</span> and <span class="math inline">\(D\)</span>, and no backdoor path between <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span> (we can do controls/selection on observables to account for this). This is generally met if our <span class="math inline">\(Z\)</span> in our non-compliance design is randomly assigned.</li>
<li><strong>Exclusions Restriction</strong>: <span class="math inline">\(Z\)</span> must only have an effect on <span class="math inline">\(Y\)</span> through <span class="math inline">\(D\)</span>. <span class="math inline">\(Z\)</span> must not have any independent effect on <span class="math inline">\(Y\)</span>.</li>
<li><strong>Monotonicity</strong>: There are no defiers - people who do the opposite of their encouragement <span class="math inline">\(Z\)</span>, no matter what <span class="math inline">\(Z\)</span> they get.</li>
</ol>
</div>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Visualisation of IV Assumption Violations
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-390858332.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%"></p>
</figure>
</div>
</div>
</div>
</div>
<p>We have two estimands of interest. The <strong>Intent to Treat (ITT)</strong> is the ATE of <span class="math inline">\(Z\)</span> on <span class="math inline">\(Y\)</span>. This is the effect of encouragement:</p>
<p><span class="math display">\[
\tau_{ITT} = \E(Y_t|Z_t = 1) - \E(Y_t | Z_t = 0)
\]</span></p>
<p>However, the ITT does not tell us anything about the effect of <span class="math inline">\(D\)</span> (the treatment), only <span class="math inline">\(Z\)</span> (the encouragement). The <strong>Local Average Treamtment Effect (LATE)</strong> provides the effect of the treatment <span class="math inline">\(D\)</span> on <span class="math inline">\(Y\)</span> for compliers (so the ITT or ATE for compliers):</p>
<p><span class="math display">\[
\tau_{LATE} = \E(\tau_t | \mathrm{compliers})
\]</span></p>
<p>The ITT itself is identifiable under exogeneity/ignorability alone. To identify the LATE, we will need all 4 assumptions. Let us define <span class="math inline">\(c\)</span> as compliers, <span class="math inline">\(a\)</span> as always-takers, <span class="math inline">\(n\)</span> as never-takers, and <span class="math inline">\(d\)</span> as defiers. We can break down the ITT into a weighted average:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c) + \tau_{ITT}^a \P(a) + \tau_{ITT}^n \P(n) + \tau_{ITT}^d \P(d)
\]</span></p>
<p>We know that under our assumption of monotonicity, we assume no defiers, so the probability of a defier is <span class="math inline">\(\P(d) = 0\)</span>:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c) + \tau_{ITT}^a \P(a) + \tau_{ITT}^n \P(n)
\]</span></p>
<p>Our exclusions restriction says that <span class="math inline">\(Z\)</span> has no independent effect on <span class="math inline">\(Y\)</span>. The ITT is the relationship between <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span>. But since always-takers and never-takers ignore <span class="math inline">\(Z\)</span> when deciding treatment, <span class="math inline">\(Z\)</span> has no effect of them on <span class="math inline">\(Y\)</span>. Thus, we can further simplify:</p>
<p><span class="math display">\[
\tau_{ITT} = \tau_{ITT}^c \P(c)
\]</span></p>
<p>Remember that the <span class="math inline">\(\tau_{ITT}\)</span> for compliers, <span class="math inline">\(\tau_{ITT}^c = \tau_{ATE}\)</span>. So, let us isolate it to get:</p>
<p><span class="math display">\[
\tau_{LATE} = \frac{\tau_{ITT}}{\P(c)} \ = \ \frac{\E(Y_i | Z_i = 1) - \E(Y_i | Z_i = 0)}{\E(D_i | Z_i = 1) - \E(D_i | Z_i = 0)}
\]</span></p>
<p>For estimation, we could our sample equivalents in. Alternatively, we can use the 2SLS estimator.</p>
<p><br></p>
</section>
<section id="regression-discontinuity" class="level2">
<h2 class="anchored" data-anchor-id="regression-discontinuity">Regression Discontinuity</h2>
<p>Regression discontinuity designs are used when treatment is assigned based on some cutoff. We have some treatment <span class="math inline">\(D_t\)</span>. There is some <strong>forcing variable</strong> <span class="math inline">\(X_t\)</span> that perfectly determines <span class="math inline">\(D_t\)</span> at some cutoff point <span class="math inline">\(X_t = c\)</span>.</p>
<p><span class="math display">\[
D_t = \begin{cases}
1 &amp; \text{if } X_t &gt; c \\
0 &amp; \text{if } X_t ≤ c
\end{cases}
\]</span></p>
<p>The idea is that right below and above the cutoff, individuals <span class="math inline">\(t\)</span> are very similar. Thus, we have quasi-random variation and comparable treatment-control groups at the cutoff which we can use to find the treatment effect at the cutoff point.</p>
<p>There are 2 main assumptions for sharp regression discontinuity:</p>
<div id="def-rdd" class="theorem definition" style="border-style: solid; border-radius: 8px; border-width: 0.5px; padding-top: 5px;   padding-right: 5px; padding-bottom: 5px; padding-left: 5px;">
<p><span class="theorem-title"><strong>Definition 5.12 (Regression Discontinuity Assumptions)</strong></span> &nbsp;</p>
<ol type="1">
<li><strong>Continuity</strong>: the potential outcomes <span class="math inline">\(\pt\)</span> and <span class="math inline">\(\pc\)</span>’s averages are continuous at cutoff <span class="math inline">\(X_t = c\)</span>. There can be no breaks or jumps in potential outcomes:</li>
</ol>
<p><span class="math display">\[
\begin{align}
&amp; \lim\limits_{\epsilon \rightarrow 0} \E (\pt | X_t = c + \epsilon) = \E (\pt | X_t = c) \\
&amp; \lim\limits_{\epsilon \rightarrow 0} \E (\pc | X_t = c + \epsilon) = \E (\pc | X_t = c) \\
\end{align}
\]</span></p>
<ol start="2" type="1">
<li><strong>Perfect Compliance</strong>: The cutoff <span class="math inline">\(X_t = c\)</span> perfectly decides who gets the treatment and who does not get the treatment.</li>
</ol>
</div>
<p>Our estimand is the <strong>Local Average Treatment Effect (LATE)</strong> at the cutoff point <span class="math inline">\(X_t = c\)</span>:</p>
<p><span class="math display">\[
\tau_{LATE} = \E(\pt - \pc | X_t = c)
\]</span></p>
<p>We can identify the LATE with the continuity assumption. We start with the LATE:</p>
<p><span class="math display">\[
\tau_{LATE} = \E(\pt | X_t = c) - \E(\pc | X_t = c)
\]</span></p>
<p>And using the assumption of continuity, we can substitute the expectations at <span class="math inline">\(X_t = c\)</span> with limits. We also know that if a limit exists, then both one-sided limits must be equal:</p>
<p><span class="math display">\[
\begin{align}
\tau_{LATE} &amp; = \lim\limits_{\epsilon \rightarrow 0} \E (\pt | X_t = c + \epsilon) - \lim\limits_{\epsilon \rightarrow 0} \E (\pc | X_t = c + \epsilon) \\
&amp; = \lim\limits_{\epsilon \rightarrow 0^+} \E (\pt | X_t = c + \epsilon) - \lim\limits_{\epsilon \rightarrow 0^-} \E (\pc | X_t = c + \epsilon)
\end{align}
\]</span></p>
<p>And we know we that individuals above the cutoff are assigned to treatment, and individuals below are assigned to control, so we can observe both of the above terms, and get:</p>
<p><span class="math display">\[
\tau_{LATE} = \lim\limits_{\epsilon \rightarrow 0^+} \E (Y_t | X_t = c + \epsilon) - \lim\limits_{\epsilon \rightarrow 0^-} \E (Y_t | X_t = c + \epsilon)
\]</span></p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Graphical Identification
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The idea of regression discontinuity is shown below. The Red is the potential outcomes <span class="math inline">\(\pt\)</span>, and the red is the potential outcomes <span class="math inline">\(\pc\)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3203444067.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>Any difference in observed outcomes at the cutoff <span class="math inline">\(X_t = c\)</span> should be the treatment effect <span class="math inline">\(\tau_{LATE}\)</span> at the cutoff.</p>
</div>
</div>
</div>
<p>To estimate a regression discontinuity, we model of potential outcomes <span class="math inline">\(\pt\)</span> and <span class="math inline">\(\pc\)</span>, and find the “discontinuity” at the cutoff.</p>
<p>If we have non-perfect assignment based on a cutoff (some people above the cutoff still don’t get treated), we can treat this as a non-compliance problem, and combine a regression discontinuity with an instrumental variables approach to get a fuzzy regression discontinuity.</p>
<p><br></p>
</section>
<section id="differences-in-differences" class="level2">
<h2 class="anchored" data-anchor-id="differences-in-differences">Differences-in-Differences</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ols.html" class="pagination-link" aria-label="Least Squares Theory">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Least Squares Theory</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./thecauses.html" class="pagination-link" aria-label="Applied Causal Inference">
        <span class="nav-page-text"><span class="chapter-title">Applied Causal Inference</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>